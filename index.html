<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Planflow ‚Äî Gesti√≥n Inteligente</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#edf5ee;--bg2:#e2ede3;--surf:#f3f8f3;--card:#fff;
  --brd:#c5dbc7;--brd2:#d8eada;
  --sage:#7aab82;--sage-d:#5a8f63;--sage-l:#b0ceb4;
  --mint:#b8dabe;--mint-l:#d8eeda;
  --fern:#4a7c52;--fern-d:#325738;
  --text:#243027;--text2:#3e5e41;--text3:#6e8e70;--text4:#9ab89c;
  --gold:#b8965a;--gold-l:#f5ead8;
  --rose:#b87878;--rose-l:#f8ecec;
  --sky:#6898b0;--sky-l:#e4eff5;
  --lav:#8e8eb8;--lav-l:#eeeef8;
  --sh:0 2px 14px rgba(60,100,67,.09);
  --sh-md:0 6px 24px rgba(60,100,67,.13);
  --sh-lg:0 12px 40px rgba(60,100,67,.18);
  --r:14px;--r2:8px;
  --fd:'Playfair Display','Cambria',Georgia,serif;
  --fb:'Lato','Trebuchet MS',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{font-family:var(--fb);background:var(--bg);color:var(--text);font-size:13.5px;display:flex;height:100vh;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--mint);border-radius:4px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}
@keyframes strBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.18)}}
/* SIDEBAR */
#sidebar{width:232px;flex-shrink:0;background:linear-gradient(170deg,#f3f8f3,#eaf3eb);border-right:1px solid var(--brd2);display:flex;flex-direction:column;padding:22px 13px 18px;overflow:hidden;transition:width .3s,padding .3s;}
#sidebar.col{width:0;padding:0;}
.logo-mark{font-family:var(--fd);font-size:24px;font-weight:700;color:var(--fern);letter-spacing:-.3px;line-height:1;margin-bottom:24px;}
.logo-mark span{color:var(--sage);}
.logo-sub{font-size:9px;color:var(--text4);letter-spacing:2.5px;font-weight:700;margin-top:1px;}
.ns{font-size:9px;color:var(--text4);letter-spacing:2px;font-weight:700;padding:0 7px;margin:14px 0 4px;}
.nb{display:flex;align-items:center;gap:8px;padding:8px 9px;border-radius:var(--r2);cursor:pointer;font-family:var(--fb);font-size:12.5px;font-weight:400;color:var(--text2);border:none;background:none;width:100%;text-align:left;transition:all .18s;white-space:nowrap;position:relative;}
.nb:hover{background:var(--mint-l);color:var(--fern);}
.nb.act{background:linear-gradient(130deg,var(--sage),var(--fern));color:#fff;font-weight:700;box-shadow:0 3px 10px rgba(90,143,99,.3);}
.nb .ico{font-size:15px;flex-shrink:0;width:18px;text-align:center;}
.nb .pct{margin-left:auto;font-size:10px;opacity:.75;}
.nb .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.nb .badge{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--rose);color:#fff;font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;}
.add-btn{display:flex;align-items:center;gap:7px;padding:8px 9px;border-radius:var(--r2);cursor:pointer;font-size:12px;color:var(--sage);border:1.5px dashed var(--mint);background:none;width:100%;text-align:left;font-family:var(--fb);font-weight:700;margin-top:5px;transition:all .18s;}
.add-btn:hover{border-color:var(--sage);background:var(--mint-l);color:var(--fern);}
#alert-pill{background:var(--rose-l);border:1px solid #e8c4c4;border-radius:10px;padding:10px 11px;margin:8px 0;cursor:pointer;display:none;}
.apl-t{font-size:11px;font-weight:700;color:var(--rose);margin-bottom:3px;}
.apl-i{font-size:10px;color:#9a5a5a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sf{margin-top:auto;padding:12px 7px 0;border-top:1px solid var(--brd2);font-size:11px;color:var(--text4);line-height:1.7;}
/* MAIN */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
#topbar{display:flex;align-items:center;gap:10px;padding:11px 22px;border-bottom:1px solid var(--brd2);background:var(--card);flex-shrink:0;box-shadow:0 1px 6px rgba(60,100,67,.06);}
.tb-title{font-family:var(--fd);font-size:20px;font-weight:600;color:var(--fern);letter-spacing:-.2px;flex:1;}
.ib{background:none;border:1px solid var(--brd);border-radius:var(--r2);padding:7px 11px;cursor:pointer;color:var(--text2);font-size:12.5px;transition:all .18s;font-family:var(--fb);font-weight:700;}
.ib:hover{background:var(--mint-l);border-color:var(--sage);color:var(--fern);}
.vs{display:flex;background:var(--bg2);border-radius:9px;padding:3px;gap:2px;}
.vt{padding:6px 13px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text3);border:none;background:none;transition:all .2s;font-family:var(--fb);}
.vt.act{background:var(--card);color:var(--fern);box-shadow:0 1px 5px rgba(60,100,67,.12);}
/* CONTENT */
#content{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.view{display:none;flex-direction:column;flex:1;overflow:hidden;}
.view.act{display:flex;}
.vscroll{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px;}
/* TYPOGRAPHY HELPERS */
.sec-t{font-family:var(--fd);font-size:19px;font-weight:600;color:var(--fern);letter-spacing:-.2px;}
.sec-s{font-size:11.5px;color:var(--text3);margin-top:2px;}
.card{background:var(--card);border:1px solid var(--brd2);border-radius:var(--r);box-shadow:var(--sh);transition:all .22s;}
/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
.sc{padding:17px 15px;display:flex;align-items:center;gap:12px;}
.sc:hover{transform:translateY(-2px);box-shadow:var(--sh-md);}
.sc-ico{width:40px;height:40px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.sc-num{font-family:var(--fd);font-size:26px;font-weight:700;line-height:1;}
.sc-lbl{font-size:10.5px;color:var(--text3);font-weight:700;letter-spacing:.3px;margin-top:1px;}
/* ALERT BANNER */
#alert-banner{display:none;border-radius:var(--r);overflow:hidden;border:1px solid #f0d0d0;background:linear-gradient(135deg,#fff5f5,#fff);animation:fadeUp .4s ease;}
/* PROJECTS */
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:15px;}
.proj-card{padding:20px;cursor:pointer;position:relative;overflow:hidden;}
.proj-card:hover{transform:translateY(-3px);box-shadow:var(--sh-lg);}
.proj-name{font-family:var(--fd);font-size:17px;font-weight:600;color:var(--text);margin-bottom:3px;margin-top:6px;}
.proj-desc{font-size:11.5px;color:var(--text3);margin-bottom:14px;line-height:1.5;}
.ring-w{position:relative;width:52px;height:52px;flex-shrink:0;}
.ring-lbl{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--fd);font-size:11px;font-weight:700;}
.spills{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px;}
.spill{font-size:10px;padding:3px 9px;border-radius:20px;font-weight:700;}
.pbar{height:4px;background:var(--bg2);border-radius:3px;overflow:hidden;margin-top:10px;}
.pfill{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1);}
.dl-u{color:var(--rose);font-weight:700;}
.dl-od{color:#c0302a;font-weight:700;background:var(--rose-l);padding:2px 8px;border-radius:10px;font-size:10px;}
/* KANBAN */
#kh{padding:18px 24px 0;flex-shrink:0;}
#kb{display:flex;gap:13px;padding:14px 24px 24px;overflow-x:auto;flex:1;align-items:flex-start;}
.kol{width:268px;flex-shrink:0;background:var(--bg2);border-radius:var(--r);padding:13px;border:1px solid var(--brd2);transition:background .2s,border .2s;}
.kol.dov{background:var(--mint-l);border-color:var(--sage);}
.kol-h{display:flex;align-items:center;gap:7px;margin-bottom:11px;}
.kol-t{font-size:11px;font-weight:700;letter-spacing:1px;flex:1;}
.kol-n{font-size:10px;padding:2px 8px;border-radius:12px;font-weight:700;}
.task-c{background:var(--card);border:1px solid var(--brd2);border-radius:10px;padding:12px;margin-bottom:8px;cursor:grab;transition:all .18s;box-shadow:0 1px 5px rgba(60,100,67,.05);position:relative;}
.task-c:hover{transform:translateY(-2px);box-shadow:0 5px 18px rgba(60,100,67,.12);}
.task-c:active{cursor:grabbing;opacity:.7;}
.task-ttl{font-family:var(--fd);font-size:13.5px;font-weight:600;color:var(--text);margin-bottom:7px;line-height:1.4;cursor:pointer;}
.task-ttl:hover{color:var(--fern);}
.tmeta{display:flex;justify-content:space-between;align-items:center;margin-top:7px;}
.tprio{font-size:9px;padding:2px 8px;border-radius:12px;font-weight:700;}
.tdue{font-size:10px;color:var(--text4);}
.tdue.od{color:var(--rose);font-weight:700;}
.tav{display:flex;align-items:center;gap:5px;margin-top:7px;}
.av{width:19px;height:19px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;}
.tact{display:flex;gap:4px;flex-wrap:wrap;margin-top:7px;}
.tab{font-size:9px;padding:2px 7px;border-radius:6px;border:none;cursor:pointer;font-family:var(--fb);font-weight:700;transition:filter .15s;}
.tab:hover{filter:brightness(.9);}
.tdel{position:absolute;top:7px;right:7px;background:none;border:none;color:var(--text4);cursor:pointer;font-size:14px;opacity:0;transition:opacity .15s;}
.task-c:hover .tdel{opacity:1;}
.kol-empty{border:1.5px dashed var(--brd);border-radius:8px;padding:18px;text-align:center;color:var(--text4);font-size:11px;}
/* CALENDAR */
#cal-top{display:flex;align-items:center;gap:9px;padding:12px 22px;border-bottom:1px solid var(--brd2);background:var(--card);flex-shrink:0;}
#cal-ttl{font-family:var(--fd);font-size:18px;font-weight:600;color:var(--fern);flex:1;}
.cnav{background:none;border:1px solid var(--brd);border-radius:7px;padding:5px 11px;cursor:pointer;color:var(--text2);font-size:16px;transition:all .15s;}
.cnav:hover{background:var(--mint-l);border-color:var(--sage);}
#cal-body{display:flex;flex:1;overflow:hidden;}
#cal-side{width:208px;flex-shrink:0;background:var(--surf);border-right:1px solid var(--brd2);padding:14px 11px;overflow-y:auto;}
#cal-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.mini-cal{background:var(--card);border:1px solid var(--brd2);border-radius:var(--r);padding:11px;margin-bottom:14px;}
.mc-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.mc-nb{background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:2px 6px;border-radius:5px;}
.mc-nb:hover{background:var(--mint-l);}
.mc-m{font-size:11px;font-weight:700;color:var(--fern);}
.mc-grid{display:grid;grid-template-columns:repeat(7,1fr);}
.mc-dh{text-align:center;font-size:8px;color:var(--text4);padding:2px 0;font-weight:700;}
.mc-d{text-align:center;padding:3px 0;cursor:pointer;border-radius:6px;font-size:10px;color:var(--text2);transition:all .15s;position:relative;}
.mc-d:hover{background:var(--mint-l);}
.mc-d.td{background:var(--fern);color:#fff;font-weight:700;}
.mc-d.sel{background:var(--sage-l);color:var(--fern);font-weight:700;}
.mc-d.hev::after{content:'';display:block;width:3px;height:3px;border-radius:50%;background:var(--sage);margin:1px auto 0;}
.gs-lbl{font-size:9px;color:var(--text4);letter-spacing:2px;font-weight:700;margin-bottom:7px;}
.gf{display:flex;align-items:center;gap:6px;padding:5px 6px;border-radius:7px;cursor:pointer;transition:all .15s;margin-bottom:2px;}
.gf:hover{background:var(--mint-l);}
.gf.off{opacity:.3;}
.gf-dot{width:9px;height:9px;border-radius:3px;flex-shrink:0;}
.gf-n{font-size:11.5px;color:var(--text2);flex:1;}
.gf-c{font-size:9px;color:var(--text4);}
.wk-hd{display:flex;border-bottom:1px solid var(--brd2);background:var(--card);flex-shrink:0;}
.wk-th{flex:1;text-align:center;padding:9px 0;border-left:1px solid var(--brd2);}
.wk-dn{font-size:9px;color:var(--text4);letter-spacing:1px;font-weight:700;}
.wk-num{width:27px;height:27px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:3px auto 0;font-size:13.5px;font-weight:700;color:var(--text);}
.wk-num.td{background:var(--fern);color:#fff;}
.t-lbl{height:58px;border-bottom:1px solid rgba(197,219,199,.15);display:flex;align-items:flex-start;justify-content:flex-end;padding:2px 6px 0;font-size:9px;color:var(--text4);}
.t-slot{height:58px;border-bottom:1px solid rgba(197,219,199,.2);cursor:pointer;transition:background .1s;}
.t-slot:hover{background:rgba(184,218,190,.25);}
.ev-block{position:absolute;left:2px;right:2px;border-radius:7px;padding:5px 7px;cursor:pointer;overflow:hidden;border-left:3px solid;transition:all .15s;z-index:2;}
.ev-block:hover{filter:brightness(.93);transform:scale(1.01);}
.ev-ttl{font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ev-time{font-size:9px;opacity:.75;margin-top:1px;}
.ev-pb{height:2px;border-radius:2px;margin-top:4px;background:rgba(255,255,255,.3);}
.ev-pf{height:100%;border-radius:2px;background:rgba(255,255,255,.75);}
.mo-h{text-align:center;padding:9px 0;font-size:10px;color:var(--text4);font-weight:700;letter-spacing:1px;}
.mo-cell{border-right:1px solid rgba(197,219,199,.15);padding:5px;cursor:pointer;transition:background .15s;min-width:0;}
.mo-cell:hover{background:var(--mint-l);}
.mo-num{width:23px;height:23px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11.5px;font-weight:600;color:var(--text2);margin-bottom:2px;}
.mo-num.td{background:var(--fern);color:#fff;font-weight:700;}
.mo-ep{font-size:9.5px;padding:2px 6px;border-radius:4px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;border-left:2.5px solid;cursor:pointer;}
/* TIMER */
.timer-ring-wrap{position:relative;width:220px;height:220px;margin:0 auto 24px;}
.timer-display{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.timer-time{font-family:var(--fd);font-size:46px;font-weight:600;color:var(--fern);letter-spacing:-1px;line-height:1;}
.timer-lbl{font-size:11px;color:var(--text3);font-weight:700;letter-spacing:1.5px;margin-top:4px;}
.session-item{display:flex;align-items:center;gap:10px;padding:10px 13px;background:var(--card);border:1px solid var(--brd2);border-radius:10px;margin-bottom:8px;animation:fadeUp .3s ease;}
.session-ico{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
/* MATRIX */
.matrix-grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto;gap:12px;}
.mq{border-radius:var(--r);padding:16px;border:1.5px solid;min-height:160px;}
.mq-lbl{font-family:var(--fd);font-size:15px;font-weight:600;margin-bottom:4px;}
.mq-sub{font-size:10.5px;margin-bottom:12px;font-weight:700;letter-spacing:.5px;}
.mq-item{padding:8px 11px;border-radius:8px;font-size:12px;cursor:pointer;border:1px solid;display:flex;align-items:center;gap:7px;margin-bottom:6px;transition:all .15s;font-family:var(--fd);}
.mq-item:hover{transform:translateX(2px);}
.mq-cb{width:14px;height:14px;border-radius:4px;border:2px solid;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.mq-add{margin-top:8px;background:none;border:1.5px dashed;border-radius:8px;width:100%;padding:7px;cursor:pointer;font-family:var(--fb);font-size:11px;font-weight:700;transition:all .15s;}
.mq-add:hover{opacity:.7;}
/* HABITS */
.habit-card{background:var(--card);border:1px solid var(--brd2);border-radius:var(--r);padding:16px;margin-bottom:12px;}
.habit-head{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.habit-name{font-family:var(--fd);font-size:14.5px;font-weight:600;color:var(--text);flex:1;}
.habit-streak{font-size:11px;color:var(--gold);font-weight:700;}
.habit-week{display:flex;gap:4px;}
.hday{width:32px;height:32px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:1.5px solid var(--brd2);background:var(--bg2);transition:all .18s;font-size:9px;color:var(--text4);font-weight:700;user-select:none;}
.hday:hover{border-color:var(--sage);}
.hday.done{background:linear-gradient(135deg,var(--sage),var(--fern));border-color:var(--sage);color:#fff;animation:strBounce .3s ease;}
.hday.tr{box-shadow:0 0 0 2px var(--sage);}
.hs-card{background:var(--card);border:1px solid var(--brd2);border-radius:var(--r);padding:16px;margin-bottom:12px;}
.hs-title{font-family:var(--fd);font-size:14px;font-weight:600;color:var(--fern);margin-bottom:12px;}
/* NOTES */
.note-card{background:var(--card);border:1px solid var(--brd2);border-radius:var(--r);padding:18px;width:260px;transition:all .2s;cursor:pointer;box-shadow:var(--sh);position:relative;}
.note-card:hover{transform:translateY(-3px);box-shadow:var(--sh-md);}
.note-title{font-family:var(--fd);font-size:15px;font-weight:600;color:var(--text);margin-bottom:8px;}
.note-body{font-size:12px;color:var(--text2);line-height:1.6;white-space:pre-wrap;}
.note-tag{font-size:9px;padding:2px 8px;border-radius:10px;font-weight:700;margin-top:10px;display:inline-block;}
.note-date{font-size:10px;color:var(--text4);margin-top:8px;}
.note-del{background:none;border:none;color:var(--text4);cursor:pointer;font-size:14px;position:absolute;top:8px;right:8px;opacity:0;transition:opacity .15s;}
.note-card:hover .note-del{opacity:1;}
/* REVIEW */
.wr-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.wr-card{background:var(--card);border:1px solid var(--brd2);border-radius:var(--r);padding:20px;}
.wr-title{font-family:var(--fd);font-size:15px;font-weight:600;color:var(--fern);margin-bottom:14px;}
.wr-metric{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--brd2);}
.wr-metric:last-child{border-bottom:none;}
.wr-mv{font-family:var(--fd);font-size:16px;font-weight:700;color:var(--fern);}
.wr-bar-row{margin-bottom:10px;}
.wr-bar-l{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:4px;}
.wr-bar{height:7px;background:var(--bg2);border-radius:4px;overflow:hidden;}
.wr-bar-f{height:100%;border-radius:4px;transition:width 1s ease;}
.win-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:linear-gradient(135deg,var(--mint-l),var(--bg));border-radius:8px;margin-bottom:7px;font-size:12px;color:var(--text2);}
/* MODAL */
.modal-bd{position:fixed;inset:0;background:rgba(36,48,39,.35);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(6px);}
.modal{background:var(--card);border-radius:18px;padding:28px;width:520px;max-width:95vw;max-height:91vh;overflow-y:auto;box-shadow:0 20px 60px rgba(36,48,39,.2);border:1px solid var(--brd2);animation:fadeUp .3s ease;}
.modal-title{font-family:var(--fd);font-size:22px;font-weight:600;color:var(--fern);margin-bottom:20px;}
.mg2{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.mg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.fr{margin-bottom:13px;}
label{font-size:9.5px;color:var(--text3);letter-spacing:1.2px;font-weight:700;display:block;margin-bottom:5px;}
input[type=text],input[type=date],input[type=number],select,textarea{width:100%;background:var(--bg2);border:1.5px solid var(--brd);border-radius:var(--r2);color:var(--text);padding:9px 12px;font-size:12.5px;font-family:var(--fb);outline:none;transition:border-color .2s,box-shadow .2s;}
input:focus,select:focus,textarea:focus{border-color:var(--sage);box-shadow:0 0 0 3px rgba(122,171,130,.14);}
input::placeholder,textarea::placeholder{color:var(--text4);}
select option{background:var(--card);color:var(--text);}
textarea{resize:vertical;min-height:70px;line-height:1.6;}
.cs{display:flex;gap:7px;flex-wrap:wrap;align-items:center;}
.csw{width:25px;height:25px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all .15s;}
.csw.sel{border-color:var(--fern);transform:scale(1.18);}
.btn-row{display:flex;gap:9px;margin-top:18px;}
.btn{padding:10px 20px;border-radius:var(--r2);border:none;cursor:pointer;font-family:var(--fb);font-size:12.5px;font-weight:700;transition:all .2s;}
.btn-p{background:linear-gradient(130deg,var(--sage),var(--fern));color:#fff;flex:2;box-shadow:0 3px 12px rgba(90,143,99,.28);}
.btn-p:hover{box-shadow:0 5px 18px rgba(90,143,99,.38);transform:translateY(-1px);}
.btn-s{background:var(--bg2);color:var(--text2);flex:1;}
.btn-s:hover{background:var(--mint-l);}
.btn-d{background:var(--rose-l);color:var(--rose);border:1px solid #e8c4c4;padding:7px 14px;}
.btn-d:hover{background:#f0d5d5;}
.cl-sec{background:var(--bg);border:1px solid var(--brd2);border-radius:var(--r);padding:13px;}
.cl-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.cl-lbl{font-size:10px;font-weight:700;color:var(--text3);letter-spacing:1px;}
.cl-pct{font-size:11px;font-weight:700;}
.ci{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--brd2);}
.ci:last-child{border-bottom:none;}
.cb{width:16px;height:16px;border-radius:4px;border:2px solid var(--brd);background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .2s;}
.cb.done{background:var(--sage);border-color:var(--sage);}
.cb.done::after{content:'‚úì';color:#fff;font-size:9.5px;font-weight:700;}
.ct{flex:1;font-size:12px;color:var(--text);transition:all .2s;}
.ct.done{color:var(--text4);text-decoration:line-through;}
.cdel{background:none;border:none;color:var(--text4);cursor:pointer;font-size:13px;padding:0 3px;opacity:0;transition:opacity .15s;}
.ci:hover .cdel{opacity:1;}
.cl-add{display:flex;gap:7px;margin-top:9px;}
.cl-add input{flex:1;}
.cl-add button{background:var(--sage);border:none;border-radius:7px;color:#fff;padding:7px 13px;cursor:pointer;font-weight:700;font-size:13px;}
.cl-add button:hover{background:var(--fern);}
.ico-grid{display:flex;flex-wrap:wrap;gap:5px;}
.ico-opt{width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;background:var(--bg2);border:2px solid transparent;transition:all .15s;}
.ico-opt:hover{background:var(--mint-l);}
.ico-opt.sel{border-color:var(--fern);background:var(--mint-l);}
/* TOAST + NOTIFY */
#toast{position:fixed;bottom:22px;right:22px;background:var(--fern);color:#fff;padding:11px 18px;border-radius:10px;font-size:12.5px;font-weight:700;box-shadow:var(--sh-lg);z-index:9999;transform:translateY(70px);opacity:0;transition:all .35s;pointer-events:none;}
#toast.show{transform:translateY(0);opacity:1;}
#nwrap{position:fixed;top:18px;right:18px;z-index:9990;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.notif{background:var(--card);border:1px solid var(--brd2);border-radius:12px;padding:12px 15px;box-shadow:var(--sh-lg);width:300px;animation:slideIn .4s ease;pointer-events:all;}
.notif-t{font-family:var(--fd);font-size:13px;font-weight:600;color:var(--rose);margin-bottom:3px;}
.notif-b{font-size:11.5px;color:var(--text2);}
.notif-x{float:right;background:none;border:none;color:var(--text4);cursor:pointer;font-size:15px;margin-left:8px;}
/* MINI TIMER */
#timer-mini{display:none;align-items:center;gap:8px;background:var(--mint-l);border:1px solid var(--brd);border-radius:8px;padding:5px 12px;font-size:12px;color:var(--fern);font-weight:700;cursor:pointer;}

/* SYNC BAR */
#sync-bar{position:fixed;bottom:0;left:0;right:0;height:36px;background:var(--card);border-top:1px solid var(--brd2);display:flex;align-items:center;gap:10px;padding:0 18px;z-index:800;box-shadow:0 -2px 10px rgba(60,100,67,.07);}
#sync-status{font-size:11px;color:var(--text4);display:flex;align-items:center;gap:5px;flex:1;}
#sync-dot{width:7px;height:7px;border-radius:50%;background:var(--sage);flex-shrink:0;transition:background .3s;}
#sync-dot.dirty{background:var(--gold);animation:pulse 1.2s infinite;}
#sync-dot.saving{background:var(--sky);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.sync-btn{padding:5px 13px;border-radius:7px;font-size:11px;font-weight:700;font-family:var(--fb);cursor:pointer;border:none;transition:all .18s;}
.sync-btn:hover{filter:brightness(.92);}
#btn-export{background:var(--mint-l);color:var(--fern);border:1px solid var(--brd);}
#btn-import{background:var(--gold-l);color:#7a5a20;border:1px solid #e8d8a0;}
#btn-reset{background:var(--rose-l);color:var(--rose);border:1px solid #f0d0d0;}
#import-file{display:none;}
body{padding-bottom:36px;}

</style>
</head>
<body>

<div id="sidebar">
  <div class="logo-mark">Plan<span>flow</span><div class="logo-sub">GESTI√ìN INTELIGENTE</div></div>
  <div id="alert-pill"><div class="apl-t">üîî Alertas</div><div id="apl-items"></div></div>
  <div class="ns">PRINCIPAL</div>
  <button class="nb" data-view="dashboard"><span class="ico">‚ú¶</span> Dashboard</button>
  <button class="nb" data-view="calendar"><span class="ico">‚óà</span> Calendario</button>
  <button class="nb" data-view="timer"><span class="ico">‚óé</span> Focus Timer</button>
  <button class="nb" data-view="matrix"><span class="ico">‚äû</span> Matriz Prioridades</button>
  <button class="nb" data-view="habits"><span class="ico">üåø</span> H√°bitos</button>
  <button class="nb" data-view="notes"><span class="ico">‚úß</span> Notas R√°pidas</button>
  <button class="nb" data-view="review"><span class="ico">‚óâ</span> Reporte Semanal</button>
  <div class="ns">PROYECTOS</div>
  <div id="sb-projects"></div>
  <button class="add-btn" id="btn-new-proj">+ Nuevo proyecto</button>
  <div class="sf" id="sf"></div>
</div>

<div id="main">
  <div id="topbar">
    <button class="ib" id="btn-toggle-sb">‚ò∞</button>
    <div><div class="tb-title" id="tb-title">Dashboard</div><div style="font-size:10.5px;color:var(--text4);" id="tb-sub"></div></div>
    <div style="flex:1"></div>
    <div id="timer-mini"><span id="tm-ico">‚ñ∂</span><span id="tm-time">25:00</span><span id="tm-lbl" style="font-weight:400;color:var(--text3);">Focus</span></div>
    <div class="vs" id="cal-vs" style="display:none;">
      <button class="vt" data-calview="day">D√≠a</button>
      <button class="vt" data-calview="week">Semana</button>
      <button class="vt" data-calview="month">Mes</button>
    </div>
    <button class="ib btn-p" id="btn-main-cta" style="border:none;color:#fff;background:linear-gradient(130deg,var(--sage),var(--fern));padding:8px 16px;">+ Nuevo</button>
  </div>

  <div id="content">
    <!-- DASHBOARD -->
    <div class="view" id="view-dashboard">
      <div class="vscroll">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div><div class="sec-t" id="dash-greet"></div><div class="sec-s" id="dash-date"></div></div>
          <button class="ib" id="btn-dash-np">+ Proyecto</button>
        </div>
        <div id="alert-banner" class="card"></div>
        <div class="stats-row" id="stats-row"></div>
        <div><div style="font-family:var(--fd);font-size:17px;font-weight:600;color:var(--fern);margin-bottom:14px;">Proyectos Activos</div>
        <div class="proj-grid" id="proj-grid"></div></div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;">
          <div class="card" style="flex:1;min-width:240px;padding:18px;"><div style="font-family:var(--fd);font-size:15px;font-weight:600;color:var(--fern);margin-bottom:12px;">Hoy ¬∑ Eventos</div><div id="today-events"></div></div>
          <div class="card" style="flex:1;min-width:240px;padding:18px;"><div style="font-family:var(--fd);font-size:15px;font-weight:600;color:var(--fern);margin-bottom:12px;">Pr√≥ximas Tareas</div><div id="upcoming-tasks"></div></div>
          <div class="card" style="flex:1;min-width:180px;padding:18px;"><div style="font-family:var(--fd);font-size:15px;font-weight:600;color:var(--fern);margin-bottom:14px;">Productividad</div><div id="prod-widget"></div></div>
        </div>
      </div>
    </div>

    <!-- KANBAN -->
    <div class="view" id="view-kanban">
      <div id="kh">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div>
            <div class="sec-t" id="kp-name"></div>
            <div class="sec-s" id="kp-desc"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-top:10px;">
              <div style="height:5px;background:var(--bg2);border-radius:3px;width:250px;overflow:hidden;"><div id="kp-fill" class="pfill" style="width:0%"></div></div>
              <span id="kp-pct" style="font-size:12px;color:var(--sage-d);font-weight:700;"></span>
            </div>
          </div>
          <button class="ib btn-p" id="btn-new-task" style="border:none;color:#fff;background:linear-gradient(130deg,var(--sage),var(--fern));padding:9px 16px;font-size:12px;">+ Tarea</button>
        </div>
      </div>
      <div id="kb"></div>
    </div>

    <!-- CALENDAR -->
    <div class="view" id="view-calendar">
      <div id="cal-top">
        <button class="cnav" id="btn-cal-prev">‚Äπ</button>
        <button class="cnav" id="btn-cal-next">‚Ä∫</button>
        <button class="ib" id="btn-cal-today">Hoy</button>
        <div id="cal-ttl"></div>
        <button class="ib btn-p" id="btn-new-event" style="border:none;color:#fff;background:linear-gradient(130deg,var(--sage),var(--fern));padding:8px 16px;font-size:12px;">+ Evento</button>
      </div>
      <div id="cal-body">
        <div id="cal-side">
          <div class="mini-cal">
            <div class="mc-nav"><button class="mc-nb" id="btn-mc-prev">‚Äπ</button><div class="mc-m" id="mc-month"></div><button class="mc-nb" id="btn-mc-next">‚Ä∫</button></div>
            <div class="mc-grid" id="mc-grid"></div>
          </div>
          <div class="gs-lbl">GRUPOS</div>
          <div id="grp-filters"></div>
          <button class="add-btn" id="btn-new-group" style="margin-top:6px;">+ Grupo</button>
        </div>
        <div id="cal-main">
          <div id="cal-day" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
            <div id="day-hd"></div>
            <div id="day-tgw" style="flex:1;overflow-y:auto;display:flex;">
              <div id="day-tl" style="width:50px;flex-shrink:0;padding-top:58px;"></div>
              <div id="day-tc" style="flex:1;border-left:1px solid var(--brd2);position:relative;"></div>
            </div>
          </div>
          <div id="cal-week" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
            <div id="wk-hd" class="wk-hd" style="display:flex;"></div>
            <div style="flex:1;overflow-y:auto;display:flex;">
              <div id="wk-tl" style="width:50px;flex-shrink:0;"></div>
              <div id="wk-tc" style="flex:1;display:flex;"></div>
            </div>
          </div>
          <div id="cal-month" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
            <div id="mo-hd" style="display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid var(--brd2);background:var(--card);flex-shrink:0;"></div>
            <div id="mo-body" style="flex:1;overflow-y:auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TIMER -->
    <div class="view" id="view-timer">
      <div class="vscroll" style="flex-direction:row;gap:22px;flex-wrap:wrap;align-items:flex-start;">
        <div style="flex:1;min-width:300px;">
          <div class="sec-t" style="margin-bottom:18px;">Focus Timer ¬∑ Pomodoro</div>
          <div class="card" style="padding:28px;text-align:center;margin-bottom:16px;">
            <div id="timer-mode-tabs" class="vs" style="justify-content:center;margin-bottom:22px;background:var(--bg2);">
              <button class="vt act" data-tmode="focus">üß† Focus 25min</button>
              <button class="vt" data-tmode="short">‚òï Descanso 5min</button>
              <button class="vt" data-tmode="long">üåø Largo 15min</button>
            </div>
            <div class="timer-ring-wrap">
              <svg width="220" height="220" style="transform:rotate(-90deg);position:absolute;top:0;left:0;">
                <circle cx="110" cy="110" r="96" fill="none" stroke="var(--bg2)" stroke-width="10"/>
                <circle id="timer-arc" cx="110" cy="110" r="96" fill="none" stroke="var(--sage)" stroke-width="10" stroke-linecap="round" stroke-dasharray="603 603"/>
              </svg>
              <div class="timer-display">
                <div class="timer-time" id="timer-display">25:00</div>
                <div class="timer-lbl" id="timer-mode-lbl">FOCUS</div>
                <div style="font-size:10px;color:var(--text4);margin-top:4px;" id="timer-sc">Sesi√≥n 1 ¬∑ üçÖ 0</div>
              </div>
            </div>
            <div style="display:flex;gap:10px;justify-content:center;margin-bottom:22px;">
              <button class="btn btn-s" id="btn-timer-reset">‚Ü∫ Reset</button>
              <button class="btn btn-p" id="btn-timer-toggle" style="border:none;padding:10px 24px;font-size:14px;">‚ñ∂ Iniciar</button>
              <button class="btn btn-s" id="btn-timer-skip">‚ü©‚ü© Saltar</button>
            </div>
            <div class="fr" style="text-align:left;margin-top:12px;">
              <label>TAREA ACTUAL</label>
              <select id="timer-task-sel"></select>
            </div>
          </div>
          <div style="font-family:var(--fd);font-size:15px;font-weight:600;color:var(--fern);margin-bottom:10px;">Sesiones de Hoy</div>
          <div id="session-log"></div>
        </div>
        <div style="flex:1;min-width:260px;">
          <div class="sec-t" style="margin-bottom:14px;">Estad√≠sticas</div>
          <div class="card" style="padding:20px;margin-bottom:14px;">
            <div style="font-family:var(--fd);font-size:14px;font-weight:600;color:var(--fern);margin-bottom:14px;">Esta Semana</div>
            <div id="focus-stats"></div>
          </div>
          <div class="card" style="padding:20px;">
            <div style="font-family:var(--fd);font-size:14px;font-weight:600;color:var(--fern);margin-bottom:12px;">Tip del D√≠a</div>
            <div id="productivity-tip" style="font-size:12px;color:var(--text2);line-height:1.7;padding:12px;background:var(--mint-l);border-radius:8px;border-left:3px solid var(--sage);"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MATRIX -->
    <div class="view" id="view-matrix">
      <div class="vscroll">
        <div><div class="sec-t">Matriz de Prioridades</div><div class="sec-s">Clasifica tareas por urgencia e importancia</div></div>
        <div class="matrix-grid" id="matrix-grid"></div>
      </div>
    </div>

    <!-- HABITS -->
    <div class="view" id="view-habits">
      <div class="vscroll" style="flex-direction:row;gap:20px;flex-wrap:wrap;align-items:flex-start;">
        <div style="flex:1;min-width:280px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
            <div class="sec-t">H√°bitos Diarios</div>
            <button class="ib" id="btn-new-habit">+ H√°bito</button>
          </div>
          <div id="habits-list"></div>
        </div>
        <div style="width:240px;flex-shrink:0;">
          <div class="sec-t" style="margin-bottom:14px;font-size:16px;">Resumen</div>
          <div class="hs-card"><div class="hs-title">Racha Actual üî•</div><div id="habit-streak" style="font-family:var(--fd);font-size:36px;font-weight:700;color:var(--gold);text-align:center;padding:8px 0;"></div><div style="font-size:11px;color:var(--text3);text-align:center;">d√≠as consecutivos</div></div>
          <div class="hs-card"><div class="hs-title">Esta Semana</div><div id="habit-week-stats"></div></div>
          <div class="hs-card"><div class="hs-title">Motivaci√≥n üí¨</div><div id="motivation-quote" style="font-size:12px;color:var(--text2);line-height:1.6;font-style:italic;padding:8px;background:var(--mint-l);border-radius:8px;"></div></div>
        </div>
      </div>
    </div>

    <!-- NOTES -->
    <div class="view" id="view-notes">
      <div class="vscroll">
        <div style="display:flex;justify-content:space-between;align-items:center;"><div class="sec-t">Notas R√°pidas</div><button class="ib" id="btn-new-note">+ Nota</button></div>
        <div id="notes-grid" style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;"></div>
      </div>
    </div>

    <!-- REVIEW -->
    <div class="view" id="view-review">
      <div class="vscroll">
        <div><div class="sec-t">Reporte Semanal</div><div class="sec-s" id="review-period"></div></div>
        <div class="wr-grid" id="review-grid"></div>
        <div class="card" style="padding:20px;"><div class="wr-title">Progreso por Proyecto</div><div id="review-projects"></div></div>
        <div class="card" style="padding:20px;"><div class="wr-title">Logros üåü</div><div id="review-wins"></div><div class="wr-title" style="margin-top:16px;">Plan Pr√≥xima Semana üéØ</div><div id="review-next"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-bd" id="modal-bd" style="display:none;">
  <div class="modal" id="modal-box"><div id="modal-content"></div></div>
</div>
<div id="nwrap"></div>
<div id="toast"></div>

<script>
(function(){

/* ‚ïê‚ïê‚ïê PERSISTENCE ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var STORAGE_KEY = 'planflow_v1';
var _saveTimer = null;
var _isDirty = false;

function getSerializableState() {
  return {
    projects: S.projects,
    events: S.events,
    groups: S.groups,
    matrix: S.matrix,
    habits: S.habits,
    notes: S.notes,
    timer: { pomodoros: S.timer.pomodoros, sessions: S.timer.sessions, focusStats: S.focusStats },
    grpFilters: Array.from(S.grpFilters),
    _counters: { pid:_pid, tid:_tid, eid:_eid, cid:_cid, gid:_gid, nid:_nid, hid:_hid, sid:_sid },
    _savedAt: new Date().toISOString()
  };
}

function saveState() {
  _isDirty = true;
  setSyncDot('dirty');
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(function() {
    try {
      var data = JSON.stringify(getSerializableState());
      localStorage.setItem(STORAGE_KEY, data);
      _isDirty = false;
      setSyncDot('saved');
      var now = new Date();
      setSyncMsg('Guardado autom√°ticamente ¬∑ ' + pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds()));
    } catch(e) {
      setSyncDot('dirty');
      setSyncMsg('Error al guardar ‚Äî almacenamiento lleno');
    }
  }, 800);
}

function loadState() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) { setSyncDot('saved'); setSyncMsg('Datos de ejemplo cargados'); return false; }
    var data = JSON.parse(raw);
    if (data.projects)  S.projects  = data.projects;
    if (data.events)    S.events    = data.events;
    if (data.groups)    S.groups    = data.groups;
    if (data.matrix)    S.matrix    = data.matrix;
    if (data.habits)    S.habits    = data.habits;
    if (data.notes)     S.notes     = data.notes;
    if (data.timer)     { S.timer.pomodoros = data.timer.pomodoros||0; S.timer.sessions = data.timer.sessions||[]; }
    if (data.timer && data.timer.focusStats) S.focusStats = data.timer.focusStats;
    if (data.grpFilters) { S.grpFilters = new Set(data.grpFilters); }
    if (data._counters) { _pid=data._counters.pid||_pid; _tid=data._counters.tid||_tid; _eid=data._counters.eid||_eid; _cid=data._counters.cid||_cid; _gid=data._counters.gid||_gid; _nid=data._counters.nid||_nid; _hid=data._counters.hid||_hid; _sid=data._counters.sid||_sid; }
    var saved = data._savedAt ? new Date(data._savedAt) : null;
    var msg = saved ? ('Restaurado ¬∑ guardado el ' + fmtD(data._savedAt.slice(0,10)) + ' a las ' + data._savedAt.slice(11,16)) : 'Datos restaurados';
    setSyncDot('saved'); setSyncMsg(msg);
    return true;
  } catch(e) {
    setSyncDot('saved'); setSyncMsg('Datos de ejemplo cargados');
    return false;
  }
}

function setSyncDot(state) {
  var dot = el('sync-dot');
  if (!dot) return;
  dot.className = '';
  if (state === 'dirty') dot.classList.add('dirty');
  else if (state === 'saving') dot.classList.add('saving');
}

function setSyncMsg(msg) {
  var el2 = el('sync-msg');
  if (el2) el2.textContent = msg;
}

function exportJSON() {
  var data = getSerializableState();
  var json = JSON.stringify(data, null, 2);
  var blob = new Blob([json], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  var now = new Date();
  a.download = 'planflow-backup-' + now.getFullYear() + pad(now.getMonth()+1) + pad(now.getDate()) + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('üì¶ Backup exportado ‚úì');
}

function importJSON(file) {
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (!data.projects && !data.events) { toast('‚ùå Archivo no v√°lido'); return; }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      loadState();
      switchView('dashboard');
      toast('‚úÖ Datos importados correctamente');
    } catch(err) {
      toast('‚ùå Error al leer el archivo JSON');
    }
  };
  reader.readAsText(file);
}

function resetData() {
  openModal('<div class="modal-title" style="color:var(--rose)">‚ö† Resetear datos</div><p style="font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.6;">Esto eliminar√° <strong>todos tus proyectos, tareas, notas, h√°bitos y eventos</strong> guardados localmente. Esta acci√≥n no se puede deshacer.<br><br>Si quieres conservar tus datos, primero <strong>exporta el JSON</strong>.</p><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-d" id="btn-confirm-reset" style="flex:1;padding:10px;">S√≠, eliminar todo</button></div>');
  el('btn-confirm-reset').addEventListener('click', function() {
    localStorage.removeItem(STORAGE_KEY);
    closeModal();
    location.reload();
  });
}


/* ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var COLORS=['#7aab82','#b8965a','#8e8eb8','#b87878','#6898b0','#a8c9ac','#c49a3c','#9e7aab'];
var ICONS=['üåø','üå∏','‚ú¶','‚óà','ü¶ã','üåô','‚≠ê','üéØ','üíº','üìã','üöÄ','üí°','üé®','ü§ù','üìä','üå∫'];
var DAYS_ES=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
var DAYS_SH=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
var MONTHS=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
var TIPS=['Regla 2 minutos: si tarda menos de 2 minutos, hazlo ahora mismo.','El flujo se alcanza eliminando distracciones por al menos 90 minutos.','Agenda tareas dif√≠ciles en tu peak de energ√≠a (9-11am generalmente).','10 minutos de planificaci√≥n nocturna ahorran una hora al d√≠a siguiente.','M√©todo 1-3-5: 1 tarea grande, 3 medianas y 5 peque√±as por d√≠a.'];
var QUOTES=['El √©xito es la suma de peque√±os esfuerzos repetidos. ‚Äî R. Collier','No cuentes los d√≠as, haz que los d√≠as cuenten. ‚Äî Muhammad Ali','Primero domina los fundamentos. ‚Äî Larry Bird','La consistencia supera a la intensidad. ‚Äî An√≥nimo'];
var STATUS_CFG={todo:{label:'Por Hacer',color:'#6e8e70',bg:'#eef5ef',badge:'#dceadd'},progress:{label:'En Progreso',color:'#4a7c52',bg:'#e8f3e9',badge:'#c8e0ca'},review:{label:'Revisi√≥n',color:'#b8965a',bg:'#fdf5e8',badge:'#f2e3c0'},done:{label:'Completado',color:'#3c6443',bg:'#e4eee5',badge:'#c0d8c2'}};
var PRIO={low:{label:'Baja',color:'#9ab89c',bg:'#eef5ef'},medium:{label:'Media',color:'#b8965a',bg:'#fdf5e8'},high:{label:'Alta',color:'#b87878',bg:'#f8ecec'}};
var MQUADS=[{key:'do',label:'Hazlo Ya',sub:'URGENTE + IMPORTANTE',color:'#b87878',bg:'#fff5f5',brd:'#f0d0d0'},{key:'plan',label:'Planif√≠calo',sub:'NO URGENTE + IMPORTANTE',color:'#4a7c52',bg:'#f0f8f0',brd:'#c5dbc7'},{key:'delegate',label:'Del√©galo',sub:'URGENTE + NO IMPORTANTE',color:'#b8965a',bg:'#fdf8f0',brd:'#e8d8b0'},{key:'elim',label:'Elim√≠nalo',sub:'NO URGENTE + NO IMPORTANTE',color:'#8e8eb8',bg:'#f5f5ff',brd:'#d0d0f0'}];
var _pid=10,_tid=100,_eid=20,_cid=200,_gid=10,_nid=10,_hid=10,_sid=10;

/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var S={
  view:'dashboard',activeProject:null,
  calView:'week',calDate:new Date(),mcDate:new Date(),
  grpFilters:new Set(['g1','g2','g3','g4','g5']),
  dragTask:null, dragPid:null,
  groups:[{id:'g1',name:'Dise√±o',color:'#7aab82',icon:'üé®'},{id:'g2',name:'Desarrollo',color:'#6898b0',icon:'üíª'},{id:'g3',name:'Marketing',color:'#b8965a',icon:'üå∏'},{id:'g4',name:'Reuniones',color:'#9da8c4',icon:'ü§ù'},{id:'g5',name:'Personal',color:'#b87878',icon:'‚≠ê'}],
  projects:[
    {id:1,name:'Redise√±o Web Corporativa',color:'#7aab82',icon:'üåø',desc:'Modernizaci√≥n completa del sitio',deadline:'2026-04-15',tasks:[
      {id:1,title:'Wireframes UX',status:'done',priority:'high',assignee:'Ana G.',due:'2026-02-10',checklist:[{id:1,text:'Presentaci√≥n inicial',done:true},{id:2,text:'Validar con cliente',done:true}]},
      {id:2,title:'Dise√±o Visual',status:'done',priority:'high',assignee:'Carlos R.',due:'2026-02-20',checklist:[{id:3,text:'Paleta de colores',done:true},{id:4,text:'Tipograf√≠as',done:true}]},
      {id:3,title:'Desarrollo Frontend',status:'progress',priority:'high',assignee:'Luis M.',due:'2026-03-10',checklist:[{id:5,text:'Header y navegaci√≥n',done:true},{id:6,text:'Homepage',done:false},{id:7,text:'P√°ginas internas',done:false}]},
      {id:4,title:'Integraci√≥n Backend',status:'progress',priority:'medium',assignee:'Mar√≠a S.',due:'2026-03-20',checklist:[{id:8,text:'API REST',done:false},{id:9,text:'Base de datos',done:false}]},
      {id:5,title:'QA y Testing',status:'todo',priority:'medium',assignee:'Pedro K.',due:'2026-04-01',checklist:[]},
      {id:6,title:'Deploy producci√≥n',status:'todo',priority:'high',assignee:'Luis M.',due:'2026-04-15',checklist:[]}
    ]},
    {id:2,name:'App Mobile Clientes',color:'#6898b0',icon:'‚óà',desc:'iOS y Android para clientes',deadline:'2026-05-30',tasks:[
      {id:7,title:'Requerimientos',status:'done',priority:'high',assignee:'Ana G.',due:'2026-02-05',checklist:[{id:10,text:'Entrevistas',done:true},{id:11,text:'User stories',done:true}]},
      {id:8,title:'Arquitectura t√©cnica',status:'done',priority:'high',assignee:'Carlos R.',due:'2026-02-15',checklist:[{id:12,text:'Tech stack',done:true}]},
      {id:9,title:'Dise√±o de pantallas',status:'review',priority:'medium',assignee:'Mar√≠a S.',due:'2026-03-01',checklist:[{id:13,text:'Onboarding',done:true},{id:14,text:'Dashboard',done:false}]},
      {id:10,title:'Desarrollo iOS',status:'todo',priority:'high',assignee:'Pedro K.',due:'2026-04-15',checklist:[]},
      {id:11,title:'Desarrollo Android',status:'todo',priority:'high',assignee:'Luis M.',due:'2026-04-15',checklist:[]}
    ]},
    {id:3,name:'Campa√±a Q2 Marketing',color:'#b8965a',icon:'üå∏',desc:'Estrategia digital Q2 2026',deadline:'2025-12-01',tasks:[
      {id:12,title:'Briefing creativo',status:'done',priority:'high',assignee:'Ana G.',due:'2025-11-10',checklist:[{id:15,text:'Objetivos',done:true},{id:16,text:'KPIs',done:true}]},
      {id:13,title:'Contenido redes',status:'progress',priority:'medium',assignee:'Mar√≠a S.',due:'2025-11-25',checklist:[{id:17,text:'Copies',done:true},{id:18,text:'Creativos',done:false}]},
      {id:14,title:'Email marketing',status:'todo',priority:'low',assignee:'Carlos R.',due:'2025-11-30',checklist:[]}
    ]}
  ],
  events:[
    {id:1,title:'Kickoff Redise√±o',groupId:'g1',date:'2026-02-23',startH:9,endH:10,projectId:1,checklist:[{id:50,text:'Preparar deck',done:true},{id:51,text:'Compartir agenda',done:false}]},
    {id:2,title:'Daily Standup',groupId:'g4',date:'2026-02-23',startH:10,endH:11,projectId:null,checklist:[{id:52,text:'Revisar avances',done:true},{id:53,text:'Bloqueos',done:false}]},
    {id:3,title:'Sprint Planning',groupId:'g2',date:'2026-02-24',startH:11,endH:13,projectId:2,checklist:[{id:54,text:'Estimar stories',done:false},{id:55,text:'Asignar tickets',done:false}]},
    {id:4,title:'UX Research',groupId:'g1',date:'2026-02-25',startH:10,endH:12,projectId:1,checklist:[{id:56,text:'Entrevistas',done:true},{id:57,text:'S√≠ntesis',done:false}]},
    {id:5,title:'Code Review',groupId:'g2',date:'2026-02-26',startH:15,endH:16,projectId:2,checklist:[{id:58,text:'Revisar PRs',done:false}]},
    {id:6,title:'Planificaci√≥n Semanal',groupId:'g5',date:'2026-02-23',startH:8,endH:9,projectId:null,checklist:[{id:59,text:'Revisar objetivos',done:false}]}
  ],
  matrix:{do:[{id:1,text:'Corregir bug cr√≠tico en producci√≥n',done:false},{id:2,text:'Responder correo urgente',done:false}],plan:[{id:3,text:'Planificar estrategia Q3',done:false},{id:4,text:'Aprender nuevo framework',done:false}],delegate:[{id:5,text:'Informe mensual de m√©tricas',done:false}],elim:[{id:6,text:'Revisar redes sociales',done:false}]},
  habits:[
    {id:1,name:'Meditaci√≥n',icon:'üßò',color:'#7aab82',days:['2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22'],streak:6},
    {id:2,name:'Ejercicio',icon:'üèÉ',color:'#b87878',days:['2026-02-18','2026-02-20','2026-02-22'],streak:1},
    {id:3,name:'Lectura 30min',icon:'üìö',color:'#6898b0',days:['2026-02-19','2026-02-20','2026-02-21','2026-02-22'],streak:4},
    {id:4,name:'Agua 2L',icon:'üíß',color:'#9da8c4',days:['2026-02-17','2026-02-18','2026-02-19','2026-02-20','2026-02-21','2026-02-22'],streak:6}
  ],
  notes:[
    {id:1,title:'Ideas para App',body:'- Gamificaci√≥n de tareas\n- Modo oscuro\n- IA para sugerencias',color:'#7aab82',tag:'Ideas',date:'2026-02-22'},
    {id:2,title:'Recursos √∫tiles',body:'notion.so\nfigma.com\nlinear.app',color:'#b8965a',tag:'Referencias',date:'2026-02-21'},
    {id:3,title:'Reflexiones Q1',body:'La consistencia supera a la intensidad. Peque√±os pasos diarios.',color:'#8e8eb8',tag:'Personal',date:'2026-02-20'}
  ],
  timer:{mode:'focus',running:false,seconds:25*60,totalSeconds:25*60,pomodoros:0,sessions:[]},
  focusStats:{Mon:3,Tue:5,Wed:2,Thu:4,Fri:6,Sat:1,Sun:0}
};

/* ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function ds(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());}
function pad(n){return String(n).padStart(2,'0');}
function tds(){return ds(new Date());}
function prog(cl){if(!cl.length)return 0;return Math.round(cl.filter(function(c){return c.done;}).length/cl.length*100);}
function wkDays(d){var x=new Date(d);x.setDate(x.getDate()-x.getDay());return Array.from({length:7},function(_,i){var n=new Date(x);n.setDate(x.getDate()+i);return n;});}
function mmx(date){
  var y=date.getFullYear(),m=date.getMonth(),fd=new Date(y,m,1),sd=fd.getDay(),rows=[],wk=[],dim=new Date(y,m+1,0).getDate();
  for(var i=0;i<sd;i++)wk.push(null);
  for(var d=1;d<=dim;d++){wk.push(new Date(y,m,d));if(wk.length===7){rows.push(wk);wk=[];}}
  while(wk.length<7)wk.push(null);
  if(wk.some(Boolean))rows.push(wk);
  while(rows.length<6)rows.push(Array(7).fill(null));
  return rows;
}
function ring(pct,color,sz){
  sz=sz||52;var r=(sz-7)/2,c=2*Math.PI*r,dd=(pct/100)*c;
  return '<svg width="'+sz+'" height="'+sz+'" style="transform:rotate(-90deg)"><circle cx="'+sz/2+'" cy="'+sz/2+'" r="'+r+'" fill="none" stroke="var(--bg2)" stroke-width="5.5"/><circle cx="'+sz/2+'" cy="'+sz/2+'" r="'+r+'" fill="none" stroke="'+color+'" stroke-width="5.5" stroke-dasharray="'+dd+' '+c+'" stroke-linecap="round"/></svg>';
}
function fmtD(s){if(!s)return'';var d=new Date(s+'T12:00:00');return d.getDate()+' '+MONTHS[d.getMonth()].slice(0,3);}
function pprog(p){if(!p.tasks.length)return 0;var w={todo:0,progress:40,review:70,done:100};return Math.round(p.tasks.reduce(function(a,t){return a+w[t.status];},0)/p.tasks.length);}
function daysUntil(s){if(!s)return null;return Math.ceil((new Date(s+'T12:00:00')-new Date())/86400000);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function el(id){return document.getElementById(id);}

/* ‚ïê‚ïê‚ïê ALERTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getAlerts(){
  var alerts=[],today=tds();
  S.projects.forEach(function(p){
    var d=daysUntil(p.deadline),pp=pprog(p);
    if(d!==null&&d<0&&pp<100)alerts.push({type:'overdue-proj',msg:'Proyecto vencido: '+p.icon+' '+p.name,sub:'Venc√≠a hace '+Math.abs(d)+' d√≠as',color:'#c0302a'});
    else if(d!==null&&d<=7&&d>=0&&pp<100)alerts.push({type:'urgent-proj',msg:'Proyecto urgente: '+p.icon+' '+p.name,sub:'Vence en '+d+' d√≠as',color:'#b87878'});
  });
  S.projects.forEach(function(p){
    p.tasks.forEach(function(t){
      if(t.due&&t.due<today&&t.status!=='done')alerts.push({type:'overdue-task',msg:'Tarea vencida: "'+t.title+'"',sub:p.name+' ¬∑ venci√≥ el '+fmtD(t.due),color:'#b87878'});
    });
  });
  var pending=0;
  S.projects.forEach(function(p){p.tasks.forEach(function(t){t.checklist.forEach(function(c){if(!c.done&&t.status!=='done')pending++;});});});
  return {alerts:alerts,pending:pending};
}
function renderAlerts(){
  var r=getAlerts(),alerts=r.alerts,pending=r.pending;
  var banner=el('alert-banner'),pill=el('alert-pill'),apl=el('apl-items');
  if(alerts.length===0){banner.style.display='none';pill.style.display='none';return;}
  banner.style.display='block';
  var html='<div style="padding:14px 18px;">';
  html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><span style="font-size:18px;">üîî</span><span style="font-family:var(--fd);font-size:15px;font-weight:600;color:var(--rose);">'+alerts.length+' Alerta'+(alerts.length>1?'s':'')+' Activa'+(alerts.length>1?'s':'')+'</span>';
  if(pending>0)html+='<span style="background:var(--rose-l);color:var(--rose);font-size:10px;font-weight:700;padding:2px 9px;border-radius:10px;">'+pending+' √≠tems pendientes</span>';
  html+='</div><div style="display:flex;flex-direction:column;gap:6px;">';
  alerts.forEach(function(a){
    html+='<div style="display:flex;align-items:center;gap:9px;padding:8px 11px;background:white;border:1px solid #f5dada;border-radius:8px;"><span style="font-size:14px;">'+(a.type.includes('proj')?'üìÅ':'‚úì')+'</span><div style="flex:1;"><div style="font-size:12px;font-weight:700;color:'+a.color+'">'+esc(a.msg)+'</div><div style="font-size:10.5px;color:#9a6060;">'+esc(a.sub)+'</div></div><span style="font-size:9px;padding:2px 8px;border-radius:10px;font-weight:700;background:'+(a.type.includes('overdue')?'#fee':'#fff3e0')+';color:'+a.color+'">'+(a.type.includes('overdue')?'VENCIDO':'URGENTE')+'</span></div>';
  });
  html+='</div></div>';
  banner.innerHTML=html;
  pill.style.display='block';
  apl.innerHTML=alerts.slice(0,2).map(function(a){return'<div class="apl-i">¬∑ '+esc(a.msg)+'</div>';}).join('');
}

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _tmpCL=[];
function openModal(html){el('modal-content').innerHTML=html;el('modal-bd').style.display='flex';}
function closeModal(){el('modal-bd').style.display='none';_tmpCL=[];}
el('modal-bd').addEventListener('click',function(e){if(e.target===el('modal-bd'))closeModal();});

function pickerHTML(prefix,colors,selIdx){
  return colors.map(function(c,i){
    return '<div class="csw'+(i===selIdx?' sel':'')+'" style="background:'+c+'" data-color="'+c+'" data-prefix="'+prefix+'"></div>';
  }).join('');
}
function iconGridHTML(){
  return ICONS.map(function(ic,i){
    return '<div class="ico-opt'+(i===0?' sel':'')+'" data-icon="'+ic+'">'+ic+'</div>';
  }).join('');
}
function checklistHTML(items,color){
  return items.map(function(c){
    return '<div class="ci"><div class="cb'+(c.done?' done':'')+'" data-cid="'+c.id+'"></div><div class="ct'+(c.done?' done':'')+'">'+esc(c.text)+'</div><button class="cdel" data-cid="'+c.id+'">√ó</button></div>';
  }).join('');
}
function progBarHTML(pct,color){
  return '<div style="display:flex;align-items:center;gap:7px;"><div style="width:70px;height:4px;background:var(--brd2);border-radius:3px;overflow:hidden;"><div style="width:'+pct+'%;height:100%;background:'+color+';transition:width .5s"></div></div><span style="font-size:11px;font-weight:700;color:'+color+'">'+pct+'%</span></div>';
}

/* Color + icon pickers via event delegation on modal-box */
el('modal-box').addEventListener('click',function(e){
  // color swatch
  var csw=e.target.closest('.csw');
  if(csw){
    var prefix=csw.dataset.prefix;
    document.querySelectorAll('.csw[data-prefix="'+prefix+'"]').forEach(function(x){x.classList.remove('sel');});
    csw.classList.add('sel');
    var inp=el(prefix+'-color-val');
    if(inp)inp.value=csw.dataset.color;
    return;
  }
  // icon option
  var io=e.target.closest('.ico-opt');
  if(io){
    document.querySelectorAll('.ico-opt').forEach(function(x){x.classList.remove('sel');});
    io.classList.add('sel');
    var iinp=el('icon-val');
    if(iinp)iinp.value=io.dataset.icon;
    return;
  }
  // checklist checkboxes
  var cb=e.target.closest('.cb[data-cid]');
  if(cb){
    var cid=parseInt(cb.dataset.cid);
    // find in _tmpCL first
    var item=_tmpCL.find(function(x){return x.id===cid;});
    if(item){item.done=!item.done;cb.classList.toggle('done',item.done);var ct=cb.nextElementSibling;if(ct){ct.classList.toggle('done',item.done);}}
    return;
  }
  // checklist delete
  var cd=e.target.closest('.cdel[data-cid]');
  if(cd){
    var cid2=parseInt(cd.dataset.cid);
    _tmpCL=_tmpCL.filter(function(x){return x.id!==cid2;});
    var row=cd.closest('.ci');if(row)row.remove();
    return;
  }
  // inline close buttons
  if(e.target.id==='modal-close-btn'||e.target.dataset.modalClose)closeModal();
});

function addCheckItem(containerId){
  var inp=el(containerId);
  if(!inp||!inp.value.trim())return;
  var item={id:_cid++,text:inp.value.trim(),done:false};
  _tmpCL.push(item);
  var container=el('cl-items-container');
  if(container){
    var div=document.createElement('div');
    div.className='ci';
    div.innerHTML='<div class="cb" data-cid="'+item.id+'"></div><div class="ct">'+esc(item.text)+'</div><button class="cdel" data-cid="'+item.id+'">√ó</button>';
    container.appendChild(div);
  }
  inp.value='';inp.focus();
}

/* ‚ïê‚ïê‚ïê VIEW SWITCHER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchView(v){
  S.view=v;
  document.querySelectorAll('.view').forEach(function(x){x.classList.remove('act');});
  var vEl=el('view-'+v);if(vEl)vEl.classList.add('act');
  document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('act');});
  var nb=document.querySelector('.nb[data-view="'+v+'"]');if(nb)nb.classList.add('act');
  el('cal-vs').style.display=v==='calendar'?'flex':'none';
  var titles={dashboard:'Dashboard',calendar:'Calendario',timer:'Focus Timer',matrix:'Matriz de Prioridades',habits:'H√°bitos Diarios',notes:'Notas R√°pidas',review:'Reporte Semanal'};
  el('tb-title').textContent=titles[v]||(S.projects.find(function(p){return p.id===S.activeProject;})||{}).name||'Kanban';
  el('tb-sub').textContent=v==='calendar'?calHdr():'';
  var ctaLabels={dashboard:'+ Proyecto',kanban:'+ Tarea',calendar:'+ Evento',timer:'',matrix:'+ Tarea',habits:'+ H√°bito',notes:'+ Nota',review:''};
  var cta=el('btn-main-cta');
  cta.textContent=ctaLabels[v]||'+ Nuevo';
  cta.style.display=ctaLabels[v]===''?'none':'';
  if(v==='dashboard')renderDashboard();
  else if(v==='kanban')renderKanban();
  else if(v==='calendar')renderCalendar();
  else if(v==='timer')renderTimer();
  else if(v==='matrix')renderMatrix();
  else if(v==='habits')renderHabits();
  else if(v==='notes')renderNotes();
  else if(v==='review')renderReview();
  renderSidebar();
}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSidebar(){
  var html=S.projects.map(function(p){
    var pp=pprog(p),d=daysUntil(p.deadline),od=d!==null&&d<0&&pp<100;
    return '<button class="nb'+(S.view==='kanban'&&S.activeProject===p.id?' act':'')+(od?' style="border-left:3px solid var(--rose)"':'')+'" data-pid="'+p.id+'"><span class="dot" style="background:'+p.color+'"></span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;'+(od?'color:var(--rose)':'')+'">'+esc(p.name)+'</span><span class="pct">'+(od?'‚ö†':'')+pp+'%</span></button>';
  }).join('');
  el('sb-projects').innerHTML=html;
  var r=getAlerts();
  el('sf').innerHTML='<div>'+S.projects.length+' proyectos ¬∑ '+S.projects.reduce(function(a,p){return a+p.tasks.length;},0)+' tareas</div><div>'+S.events.length+' eventos</div>'+(r.alerts.length>0?'<div style="color:var(--rose);font-weight:700;margin-top:3px;">‚ö† '+r.alerts.length+' alerta'+(r.alerts.length>1?'s':'')+'</div>':'');
  // project buttons
  document.querySelectorAll('#sb-projects .nb').forEach(function(btn){
    btn.addEventListener('click',function(){openKanban(parseInt(btn.dataset.pid));});
  });
}

/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDashboard(){
  var n=new Date(),h=n.getHours();
  el('dash-greet').textContent=(h<12?'Buenos d√≠as ‚òÄÔ∏è':h<18?'Buenas tardes üåø':'Buenas noches üåô');
  el('dash-date').textContent=DAYS_ES[n.getDay()]+', '+n.getDate()+' de '+MONTHS[n.getMonth()]+' '+n.getFullYear();
  renderAlerts();
  var allT=S.projects.reduce(function(a,p){return a.concat(p.tasks);},[]); 
  var doneN=allT.filter(function(t){return t.status==='done';}).length;
  var inpN=allT.filter(function(t){return t.status==='progress';}).length;
  var r=getAlerts();
  el('stats-row').innerHTML=[
    {lbl:'Proyectos',val:S.projects.length,ico:'‚ú¶',c:'#7aab82'},
    {lbl:'Tareas',val:allT.length,ico:'‚óà',c:'#6898b0'},
    {lbl:'En Progreso',val:inpN,ico:'‚ü≥',c:'#b8965a'},
    {lbl:'Completadas',val:doneN,ico:'‚úì',c:'#3c6443'},
    {lbl:'Alertas',val:r.alerts.length,ico:'üîî',c:r.alerts.length>0?'#b87878':'#9ab89c'}
  ].map(function(s){return '<div class="card sc"><div class="sc-ico" style="background:'+s.c+'18;color:'+s.c+'">'+s.ico+'</div><div><div class="sc-num" style="color:'+s.c+'">'+s.val+'</div><div class="sc-lbl">'+s.lbl+'</div></div></div>';}).join('');

  el('proj-grid').innerHTML=S.projects.map(function(p){
    var pp=pprog(p),dN=p.tasks.filter(function(t){return t.status==='done';}).length,d=daysUntil(p.deadline);
    var od=d!==null&&d<0&&pp<100,urg=d!==null&&d<=7&&d>=0&&pp<100;
    var dlHtml=d===null?'':(od?'<span class="dl-od">‚ö† Vencido hace '+Math.abs(d)+' d√≠as</span>':d===0?'<span class="dl-u">‚ö† Vence hoy</span>':'<span style="font-size:10px;color:var(--text4);">'+d+' d√≠as restantes</span>');
    var badges=Object.keys(STATUS_CFG).map(function(s){var n=p.tasks.filter(function(t){return t.status===s;}).length;return n>0?'<span class="spill" style="background:'+STATUS_CFG[s].bg+';color:'+STATUS_CFG[s].color+'">'+n+' '+STATUS_CFG[s].label+'</span>':'';}).join('');
    return '<div class="card proj-card" data-ppid="'+p.id+'" style="border-top:3px solid '+p.color+'"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-top:4px;"><div style="flex:1;"><div class="proj-name">'+esc(p.icon)+' '+esc(p.name)+'</div><div class="proj-desc">'+esc(p.desc)+'</div></div><div class="ring-w">'+ring(pp,p.color,52)+'<div class="ring-lbl" style="color:'+p.color+'">'+pp+'%</div></div></div><div class="spills">'+badges+'</div><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-size:11px;color:var(--text3)">'+dN+'/'+p.tasks.length+' tareas</span>'+dlHtml+'</div><div class="pbar"><div class="pfill" style="width:'+pp+'%;background:'+p.color+'"></div></div></div>';
  }).join('');
  document.querySelectorAll('.proj-card').forEach(function(c){c.addEventListener('click',function(){openKanban(parseInt(c.dataset.ppid));});});

  var todayEvs=S.events.filter(function(e){return e.date===tds();});
  var teEl=el('today-events');
  if(todayEvs.length===0){teEl.innerHTML='<div style="font-size:12px;color:var(--text4);text-align:center;padding:14px;">Sin eventos hoy</div>';}
  else{teEl.innerHTML=todayEvs.map(function(ev){var g=S.groups.find(function(x){return x.id===ev.groupId;})||{color:'var(--sage)',icon:'‚óè'};var pp=prog(ev.checklist);return'<div style="display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--brd2);cursor:pointer;" data-evid="'+ev.id+'"><div style="width:3px;height:36px;border-radius:2px;background:'+g.color+';flex-shrink:0;"></div><div style="flex:1;min-width:0;"><div style="font-size:12.5px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+esc(g.icon)+' '+esc(ev.title)+'</div><div style="font-size:10px;color:var(--text4);">'+pad(ev.startH)+':00 ‚Äì '+pad(ev.endH)+':00</div></div>'+(pp>0?'<div style="font-size:10px;font-weight:700;color:'+g.color+';">'+pp+'%</div>':'')+'</div>';}).join('');
  teEl.querySelectorAll('[data-evid]').forEach(function(el2){el2.addEventListener('click',function(){openEventDetail(parseInt(el2.dataset.evid));});});}

  var upcoming=[];
  S.projects.forEach(function(p){p.tasks.filter(function(t){return t.status!=='done'&&t.due;}).forEach(function(t){upcoming.push(Object.assign({},t,{projColor:p.color,projName:p.name}));});});
  upcoming.sort(function(a,b){return a.due.localeCompare(b.due);});
  el('upcoming-tasks').innerHTML=upcoming.slice(0,6).map(function(t){var d=daysUntil(t.due),od=d<0;return'<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--brd2);"><div style="width:8px;height:8px;border-radius:50%;background:'+t.projColor+';flex-shrink:0;"></div><div style="flex:1;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+esc(t.title)+'</div><div style="font-size:10px;font-weight:700;color:'+(od?'var(--rose)':'var(--text3)')+';">'+(od?'‚ö† ':'')+fmtD(t.due)+'</div></div>';}).join('');

  var hp=allT.length>0?Math.round(doneN/allT.length*100):0;
  var habDone=S.habits.filter(function(h){return h.days.includes(tds());}).length;
  el('prod-widget').innerHTML='<div style="text-align:center;margin-bottom:10px;">'+ring(hp,'var(--fern)',70)+'</div><div style="text-align:center;margin-top:-56px;margin-bottom:16px;font-family:var(--fd);font-size:18px;font-weight:700;color:var(--fern);">'+hp+'%</div><div style="margin-top:20px;padding:10px;background:var(--mint-l);border-radius:8px;font-size:11.5px;color:var(--text2);text-align:center;">üåø '+habDone+'/'+S.habits.length+' h√°bitos hoy</div>';
  renderSidebar();
}

/* ‚ïê‚ïê‚ïê KANBAN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openKanban(pid){S.activeProject=pid;switchView('kanban');}
function renderKanban(){
  var p=S.projects.find(function(x){return x.id===S.activeProject;});if(!p)return;
  el('kp-name').textContent=p.icon+' '+p.name;
  el('kp-desc').textContent=p.desc;
  var pp=pprog(p);
  el('kp-fill').style.cssText='width:'+pp+'%;background:'+p.color;
  el('kp-pct').textContent=pp+'% completado';
  var html='';
  Object.keys(STATUS_CFG).forEach(function(st){
    var cfg=STATUS_CFG[st],tasks=p.tasks.filter(function(t){return t.status===st;});
    html+='<div class="kol" id="kol-'+st+'"><div class="kol-h"><div style="width:9px;height:9px;border-radius:50%;background:'+cfg.color+';flex-shrink:0;"></div><div class="kol-t" style="color:'+cfg.color+'">'+cfg.label.toUpperCase()+'</div><div class="kol-n" style="background:'+cfg.badge+';color:'+cfg.color+'">'+tasks.length+'</div></div>';
    if(tasks.length===0)html+='<div class="kol-empty">Arrastra tareas aqu√≠</div>';
    tasks.forEach(function(t){html+=taskCardHTML(t,p);});
    html+='</div>';
  });
  el('kb').innerHTML=html;
  // drag and drop
  document.querySelectorAll('.kol').forEach(function(kol){
    kol.addEventListener('dragover',function(e){e.preventDefault();kol.classList.add('dov');});
    kol.addEventListener('dragleave',function(){kol.classList.remove('dov');});
    kol.addEventListener('drop',function(e){e.preventDefault();kol.classList.remove('dov');if(S.dragTask!==null)moveTask(S.dragPid,S.dragTask,kol.id.replace('kol-',''));});
  });
  // task card events via delegation on kb
  el('kb').addEventListener('click',function(e){
    var del=e.target.closest('.tdel');if(del){delTask(parseInt(del.dataset.pid),parseInt(del.dataset.tid));return;}
    var ttl=e.target.closest('.task-ttl');if(ttl){openTaskDetail(parseInt(ttl.dataset.pid),parseInt(ttl.dataset.tid));return;}
    var tab=e.target.closest('.tab');if(tab){moveTask(parseInt(tab.dataset.pid),parseInt(tab.dataset.tid),tab.dataset.st);return;}
  });
  document.querySelectorAll('.task-c').forEach(function(tc){
    tc.addEventListener('dragstart',function(){S.dragTask=parseInt(tc.dataset.tid);S.dragPid=parseInt(tc.dataset.pid);});
    tc.addEventListener('dragend',function(){S.dragTask=null;S.dragPid=null;document.querySelectorAll('.kol').forEach(function(k){k.classList.remove('dov');});});
  });
  renderSidebar();
}
function taskCardHTML(t,p){
  var pc=PRIO[t.priority]||PRIO.medium,pp=prog(t.checklist),d=daysUntil(t.due),od=d!==null&&d<0&&t.status!=='done';
  var html='<div class="task-c" draggable="true" data-tid="'+t.id+'" data-pid="'+p.id+'">';
  html+='<button class="tdel" data-tid="'+t.id+'" data-pid="'+p.id+'">√ó</button>';
  html+='<div class="task-ttl" data-tid="'+t.id+'" data-pid="'+p.id+'">'+esc(t.title)+'</div>';
  if(t.checklist.length>0)html+='<div style="margin:6px 0 4px;"><div class="pbar"><div class="pfill" style="width:'+pp+'%;background:'+p.color+'"></div></div><div style="font-size:9px;color:var(--text4);margin-top:2px;">'+pp+'% ¬∑ '+t.checklist.filter(function(c){return c.done;}).length+'/'+t.checklist.length+'</div></div>';
  html+='<div class="tmeta"><span class="tprio" style="background:'+pc.bg+';color:'+pc.color+'">'+pc.label+'</span>'+(t.due?'<span class="tdue'+(od?' od':'')+'"> '+(od?'‚ö† ':'')+fmtD(t.due)+'</span>':'')+'</div>';
  if(t.assignee)html+='<div class="tav"><div class="av" style="background:'+p.color+'20;color:'+p.color+'">'+t.assignee.split(' ').map(function(x){return x[0]||'';}).join('').slice(0,2)+'</div><span style="font-size:11px;color:var(--text3)">'+esc(t.assignee)+'</span></div>';
  html+='<div class="tact">'+Object.keys(STATUS_CFG).filter(function(s){return s!==t.status;}).map(function(s){var c=STATUS_CFG[s];return'<button class="tab" data-tid="'+t.id+'" data-pid="'+p.id+'" data-st="'+s+'" style="background:'+c.bg+';color:'+c.color+'">'+c.label+'</button>';}).join('')+'</div>';
  html+='</div>';
  return html;
}
function moveTask(pid,tid,status){
  var p=S.projects.find(function(x){return x.id==pid;}),t=p&&p.tasks.find(function(x){return x.id==tid;});
  if(t){t.status=status;renderKanban();saveState();toast('‚Üí "'+STATUS_CFG[status].label+'"');}
}
function delTask(pid,tid){
  var p=S.projects.find(function(x){return x.id==pid;});
  if(p){p.tasks=p.tasks.filter(function(t){return t.id!==tid;});renderKanban();saveState();toast('Tarea eliminada');}
}

/* ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function calHdr(){var cd=S.calDate,cv=S.calView;if(cv==='day')return DAYS_ES[cd.getDay()]+', '+cd.getDate()+' de '+MONTHS[cd.getMonth()]+' '+cd.getFullYear();if(cv==='week'){var wd=wkDays(cd);return wd[0].getDate()+' ‚Äì '+wd[6].getDate()+' '+MONTHS[cd.getMonth()]+' '+cd.getFullYear();}return MONTHS[cd.getMonth()]+' '+cd.getFullYear();}
function renderCalendar(){renderGF();renderMC();renderCalView();el('cal-ttl').textContent=calHdr();renderSidebar();}
function setCalView(v){S.calView=v;document.querySelectorAll('#cal-vs .vt').forEach(function(b){b.classList.toggle('act',b.dataset.calview===v);});el('cal-ttl').textContent=calHdr();renderCalView();}
function calNav(d){var x=new Date(S.calDate);if(S.calView==='day')x.setDate(x.getDate()+d);else if(S.calView==='week')x.setDate(x.getDate()+d*7);else x.setMonth(x.getMonth()+d);S.calDate=x;el('cal-ttl').textContent=calHdr();renderCalView();}
function renderCalView(){
  ['day','week','month'].forEach(function(v){var e=el('cal-'+v);if(e)e.style.display='none';});
  var cv=S.calView,e2=el('cal-'+cv);if(e2)e2.style.display='flex';
  if(cv==='day')renderDayV();else if(cv==='week')renderWeekV();else renderMonthV();
}
function filtEvs(date){return S.events.filter(function(e){return e.date===date&&S.grpFilters.has(e.groupId);});}
function allFiltEvs(){return S.events.filter(function(e){return S.grpFilters.has(e.groupId);});}
function tLabelsHTML(){return Array.from({length:24},function(_,h){return'<div class="t-lbl">'+pad(h)+':00</div>';}).join('');}
function tSlotsHTML(dateStr){return Array.from({length:24},function(_,h){return'<div class="t-slot" data-date="'+dateStr+'" data-h="'+h+'"></div>';}).join('');}
function evBlockHTML(ev){
  var g=S.groups.find(function(x){return x.id===ev.groupId;})||{color:'var(--sage)',icon:'‚óè'};
  var top=ev.startH*58,h2=Math.max((ev.endH-ev.startH)*58-4,26),pp=prog(ev.checklist);
  return'<div class="ev-block" data-evid="'+ev.id+'" style="top:'+top+'px;height:'+h2+'px;background:'+g.color+'1e;border-color:'+g.color+'40;border-left-color:'+g.color+';"><div class="ev-ttl" style="color:'+g.color+'">'+esc(g.icon)+' '+esc(ev.title)+'</div>'+(h2>34?'<div class="ev-time" style="color:'+g.color+'">'+pad(ev.startH)+':00‚Äì'+pad(ev.endH)+':00</div>':'')+(h2>50&&ev.checklist.length>0?'<div class="ev-pb"><div class="ev-pf" style="width:'+pp+'%;background:'+g.color+'"></div></div>':'')+'</div>';
}
function setupTimeGrid(container){
  container.addEventListener('click',function(e){
    var slot=e.target.closest('.t-slot');if(slot){openNewEvent(slot.dataset.date,parseInt(slot.dataset.h));return;}
    var ev=e.target.closest('.ev-block');if(ev){openEventDetail(parseInt(ev.dataset.evid));return;}
  });
}
function renderDayV(){
  var dateStr=ds(S.calDate),evs=filtEvs(dateStr),td=dateStr===tds();
  el('day-hd').innerHTML='<div style="padding:12px 20px;border-bottom:1px solid var(--brd2);"><div style="font-family:var(--fd);font-size:32px;font-weight:600;color:'+(td?'var(--fern)':'var(--text)')+';line-height:1;">'+S.calDate.getDate()+'</div><div style="font-size:12px;color:var(--text3);">'+DAYS_ES[S.calDate.getDay()]+' ¬∑ '+MONTHS[S.calDate.getMonth()]+' '+S.calDate.getFullYear()+'</div></div>';
  el('day-tl').innerHTML=tLabelsHTML();
  var tc=el('day-tc');tc.innerHTML=tSlotsHTML(dateStr);evs.forEach(function(ev){tc.insertAdjacentHTML('beforeend',evBlockHTML(ev));});setupTimeGrid(tc);
}
function renderWeekV(){
  var days=wkDays(S.calDate),td=tds();
  el('wk-hd').innerHTML='<div style="width:50px;flex-shrink:0;"></div>'+days.map(function(d){var dateStr=ds(d),isTd=dateStr===td;return'<div class="wk-th"><div class="wk-dn">'+DAYS_SH[d.getDay()]+'</div><div class="wk-num'+(isTd?' td':'')+'">'+d.getDate()+'</div></div>';}).join('');
  el('wk-tl').innerHTML=tLabelsHTML();
  var tc=el('wk-tc');tc.innerHTML=days.map(function(d){var dateStr=ds(d),evs=filtEvs(dateStr);return'<div style="flex:1;border-left:1px solid var(--brd2);position:relative;">'+tSlotsHTML(dateStr)+evs.map(function(ev){return evBlockHTML(ev);}).join('')+'</div>';}).join('');
  setupTimeGrid(tc);
}
function renderMonthV(){
  var matrix=mmx(S.calDate),td=tds(),cm=S.calDate.getMonth();
  el('mo-hd').innerHTML=DAYS_SH.map(function(d){return'<div class="mo-h">'+d+'</div>';}).join('');
  el('mo-body').innerHTML=matrix.map(function(wk){
    return'<div style="display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid rgba(197,219,199,.15);">'+wk.map(function(d){
      if(!d)return'<div class="mo-cell" style="background:rgba(226,237,227,.3);"></div>';
      var dateStr=ds(d),isTd=dateStr===td,isOt=d.getMonth()!==cm;
      var evs=allFiltEvs().filter(function(e){return e.date===dateStr;});
      return'<div class="mo-cell'+(isOt?' other-month':'')+'" data-date="'+dateStr+'"><div class="mo-num'+(isTd?' td':'')+'" style="'+(isOt?'color:var(--text4)':'')+'">'+d.getDate()+'</div>'+evs.slice(0,3).map(function(ev){var g=S.groups.find(function(x){return x.id===ev.groupId;})||{color:'var(--sage)'};return'<div class="mo-ep" data-evid="'+ev.id+'" style="background:'+g.color+'18;color:'+g.color+';border-left-color:'+g.color+';">'+esc(ev.title)+'</div>';}).join('')+(evs.length>3?'<div style="font-size:9px;color:var(--text4);padding:1px 4px;">+'+(evs.length-3)+'</div>':'')+'</div>';
    }).join('')+'</div>';
  }).join('');
  el('mo-body').addEventListener('click',function(e){
    var ep=e.target.closest('.mo-ep');if(ep){e.stopPropagation();openEventDetail(parseInt(ep.dataset.evid));return;}
    var cell=e.target.closest('.mo-cell[data-date]');if(cell){S.calDate=new Date(cell.dataset.date+'T12:00:00');setCalView('day');}
  });
}
function renderGF(){
  el('grp-filters').innerHTML=S.groups.map(function(g){return'<div class="gf'+(S.grpFilters.has(g.id)?'':' off')+'" data-gid="'+g.id+'"><div class="gf-dot" style="background:'+g.color+'"></div><span class="gf-n">'+esc(g.name)+'</span><span style="font-size:11px;">'+g.icon+'</span><span class="gf-c">'+S.events.filter(function(e){return e.groupId===g.id;}).length+'</span></div>';}).join('');
  el('grp-filters').querySelectorAll('.gf').forEach(function(gf){gf.addEventListener('click',function(){var gid=gf.dataset.gid;if(S.grpFilters.has(gid))S.grpFilters.delete(gid);else S.grpFilters.add(gid);renderGF();renderCalView();});});
}
function renderMC(){
  var d=S.mcDate,td=tds(),sel=ds(S.calDate),evDates=new Set(S.events.map(function(e){return e.date;}));
  el('mc-month').textContent=MONTHS[d.getMonth()].slice(0,3)+' '+d.getFullYear();
  el('mc-grid').innerHTML=DAYS_SH.map(function(x){return'<div class="mc-dh">'+x[0]+'</div>';}).join('')+mmx(d).reduce(function(a,w){return a.concat(w);},[]).map(function(day){
    if(!day)return'<div></div>';
    var dateStr=ds(day),isTd=dateStr===td,isSel=dateStr===sel,hev=evDates.has(dateStr);
    return'<div class="mc-d'+(isTd?' td':isSel?' sel':'')+(hev&&!isTd?' hev':'')+'" data-date="'+dateStr+'">'+day.getDate()+'</div>';
  }).join('');
  el('mc-grid').querySelectorAll('.mc-d').forEach(function(mc){mc.addEventListener('click',function(){S.calDate=new Date(mc.dataset.date+'T12:00:00');S.mcDate=new Date(mc.dataset.date+'T12:00:00');renderCalendar();});});
}

/* ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var timerInterval=null;
var TMODES={focus:{label:'FOCUS',secs:25*60,color:'var(--sage)'},short:{label:'DESCANSO',secs:5*60,color:'var(--sky)'},long:{label:'LARGO',secs:15*60,color:'var(--lav)'}};
function renderTimer(){
  updateTimerDisp();renderSessionLog();renderFocusStats();
  var tipEl=el('productivity-tip');if(tipEl)tipEl.textContent=TIPS[Math.floor(Math.random()*TIPS.length)];
  var sel=el('timer-task-sel');
  if(sel){sel.innerHTML='<option value="">Sin tarea asignada</option>'+S.projects.reduce(function(a,p){return a+p.tasks.filter(function(t){return t.status!=='done';}).map(function(t){return'<option value="'+t.id+'">['+p.name.slice(0,12)+'] '+esc(t.title)+'</option>';}).join('');},'');}
}
function updateTimerDisp(){
  var t=S.timer,m=TMODES[t.mode],mins=Math.floor(t.seconds/60),secs=t.seconds%60,disp=pad(mins)+':'+pad(secs);
  var de=el('timer-display');if(de)de.textContent=disp;
  var le=el('timer-mode-lbl');if(le)le.textContent=m.label;
  var sc=el('timer-sc');if(sc)sc.textContent='Sesi√≥n '+(t.sessions.length+1)+' ¬∑ üçÖ '+t.pomodoros;
  var arc=el('timer-arc');if(arc){var pct=t.seconds/t.totalSeconds,circ=2*Math.PI*96;arc.style.strokeDasharray=(pct*circ)+' '+circ;arc.setAttribute('stroke',m.color);}
  var btn=el('btn-timer-toggle');if(btn)btn.textContent=t.running?'‚è∏ Pausar':'‚ñ∂ Iniciar';
  var tm=el('timer-mini');if(tm){if(t.running||t.seconds<t.totalSeconds){tm.style.display='flex';var tt=el('tm-time');if(tt)tt.textContent=disp;var tl=el('tm-lbl');if(tl)tl.textContent=m.label;}else{tm.style.display='none';}}
}
function timerToggle(){S.timer.running=!S.timer.running;if(S.timer.running)timerInterval=setInterval(timerTick,1000);else clearInterval(timerInterval);updateTimerDisp();}
function timerTick(){if(S.timer.seconds<=0){timerComplete();return;}S.timer.seconds--;updateTimerDisp();}
function timerComplete(){
  clearInterval(timerInterval);S.timer.running=false;
  if(S.timer.mode==='focus'){
    S.timer.pomodoros++;
    var sel=el('timer-task-sel'),taskTitle='Sin tarea';
    if(sel&&sel.value){var allT=S.projects.reduce(function(a,p){return a.concat(p.tasks);},[]);var t=allT.find(function(x){return x.id==sel.value;});if(t)taskTitle=t.title;}
    S.timer.sessions.push({id:_sid++,task:taskTitle,duration:25,time:new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})});
    notify('üçÖ ¬°Pomodoro completado!',S.timer.pomodoros+' sesiones hoy. ¬°Descansa un poco!');
  }
  renderSessionLog();renderFocusStats();
}
function timerReset(){clearInterval(timerInterval);S.timer.running=false;S.timer.seconds=S.timer.totalSeconds;updateTimerDisp();}
function renderSessionLog(){
  var el2=el('session-log');if(!el2)return;
  if(S.timer.sessions.length===0){el2.innerHTML='<div style="font-size:12px;color:var(--text4);padding:14px;text-align:center;background:var(--card);border-radius:10px;">Ninguna sesi√≥n a√∫n. ¬°Empieza!</div>';return;}
  el2.innerHTML=S.timer.sessions.slice().reverse().map(function(s){return'<div class="session-item"><div class="session-ico" style="background:var(--mint-l);color:var(--fern)">üçÖ</div><div style="flex:1;"><div style="font-size:12.5px;font-weight:700;color:var(--text);font-family:var(--fd);">'+esc(s.task)+'</div><div style="font-size:10.5px;color:var(--text3);">'+s.duration+' min ¬∑ '+s.time+'</div></div></div>';}).join('');
}
function renderFocusStats(){
  var el2=el('focus-stats');if(!el2)return;
  var days=['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],data=[S.focusStats.Mon,S.focusStats.Tue,S.focusStats.Wed,S.focusStats.Thu,S.focusStats.Fri,S.focusStats.Sat,S.focusStats.Sun],mx=Math.max.apply(null,data.concat([1]));
  el2.innerHTML=days.map(function(d,i){return'<div class="wr-bar-row"><div class="wr-bar-l"><span>'+d+'</span><span style="font-weight:700;color:var(--fern)">'+data[i]+' üçÖ</span></div><div class="wr-bar"><div class="wr-bar-f" style="width:'+data[i]/mx*100+'%;background:var(--sage)"></div></div></div>';}).join('');
}

/* ‚ïê‚ïê‚ïê MATRIX ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderMatrix(){
  el('matrix-grid').innerHTML=MQUADS.map(function(q){
    var items=(S.matrix[q.key]||[]).map(function(item){
      return'<div class="mq-item" style="background:'+q.bg+';border-color:'+q.brd+';'+(item.done?'opacity:.5;text-decoration:line-through;':'')+'"><div class="mq-cb" data-mkey="'+q.key+'" data-mid="'+item.id+'" style="border-color:'+q.color+';background:'+(item.done?q.color:'transparent')+';">'+(item.done?'<span style="color:#fff;font-size:9px;">‚úì</span>':'')+'</div><span style="flex:1;color:'+q.color+';">'+esc(item.text)+'</span><button style="background:none;border:none;color:'+q.color+';opacity:.5;cursor:pointer;font-size:13px;" data-mkey="'+q.key+'" data-mdel="'+item.id+'">√ó</button></div>';
    }).join('');
    return'<div class="mq" style="background:'+q.bg+';border-color:'+q.brd+';"><div class="mq-lbl" style="color:'+q.color+'">'+q.label+'</div><div class="mq-sub" style="color:'+q.color+'80;">'+q.sub+'</div><div>'+items+'</div><button class="mq-add" style="border-color:'+q.color+'50;color:'+q.color+';" data-mkey="'+q.key+'" data-mcolor="'+q.color+'" data-mlabel="'+q.label+'">+ Agregar tarea</button></div>';
  }).join('');
  el('matrix-grid').addEventListener('click',function(e){
    var cb=e.target.closest('.mq-cb');if(cb){var k=cb.dataset.mkey,id=parseInt(cb.dataset.mid),it=(S.matrix[k]||[]).find(function(x){return x.id===id;});if(it){it.done=!it.done;saveState();renderMatrix();}return;}
    var dl=e.target.closest('[data-mdel]');if(dl){var k2=dl.dataset.mkey,id2=parseInt(dl.dataset.mdel);S.matrix[k2]=S.matrix[k2].filter(function(x){return x.id!==id2;});renderMatrix();return;}
    var add=e.target.closest('.mq-add');if(add){openMAdd(add.dataset.mkey,add.dataset.mcolor,add.dataset.mlabel);}
  });
}
function openMAdd(k,color,label){
  openModal('<div class="modal-title" style="color:'+color+'">Agregar a "'+esc(label)+'"</div><div class="fr"><label>TAREA</label><input type="text" id="mi-txt" placeholder="Describe la tarea‚Ä¶"/></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-mitem">Agregar</button></div>');
  el('btn-save-mitem').addEventListener('click',function(){var v=el('mi-txt')&&el('mi-txt').value.trim();if(!v)return;if(!S.matrix[k])S.matrix[k]=[];S.matrix[k].push({id:_cid++,text:v,done:false});closeModal();renderMatrix();saveState();toast('Tarea agregada ‚úì');});
  setTimeout(function(){var inp=el('mi-txt');if(inp)inp.focus();},50);
}

/* ‚ïê‚ïê‚ïê HABITS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderHabits(){
  var td=tds(),wd=wkDays(S.calDate).map(function(d){return ds(d);});
  el('habits-list').innerHTML=S.habits.map(function(h){
    var weekHTML=wd.map(function(d){var done=h.days.includes(d),isT=d===td,dn=DAYS_SH[new Date(d+'T12:00:00').getDay()];return'<div class="hday'+(done?' done':'')+(isT?' tr':'')+'" data-hid="'+h.id+'" data-date="'+d+'"><span style="font-size:8px">'+dn[0]+'</span><span>'+(done?'‚úì':isT?'¬∑':'')+'</span></div>';}).join('');
    var wDone=h.days.filter(function(d){return wd.includes(d);}).length;
    return'<div class="habit-card"><div class="habit-head"><span style="font-size:22px">'+h.icon+'</span><div class="habit-name">'+esc(h.name)+'</div><div class="habit-streak">üî• '+h.streak+' d√≠as</div><button style="background:none;border:none;color:var(--text4);cursor:pointer;font-size:14px;" data-delhab="'+h.id+'">√ó</button></div><div class="habit-week">'+weekHTML+'</div><div style="margin-top:10px;"><div class="pbar"><div class="pfill" style="width:'+Math.round(wDone/7*100)+'%;background:'+h.color+'"></div></div><div style="font-size:10px;color:var(--text4);margin-top:2px;">'+wDone+'/7 esta semana</div></div></div>';
  }).join('');
  document.querySelectorAll('.habit-week .hday').forEach(function(hd){hd.addEventListener('click',function(){toggleHabit(parseInt(hd.dataset.hid),hd.dataset.date);});});
  document.querySelectorAll('[data-delhab]').forEach(function(b){b.addEventListener('click',function(){S.habits=S.habits.filter(function(h){return h.id!==parseInt(b.dataset.delhab);});renderHabits();});});
  var maxS=S.habits.length>0?Math.max.apply(null,S.habits.map(function(h){return h.streak;})):0;
  el('habit-streak').textContent=maxS;
  el('habit-week-stats').innerHTML=S.habits.map(function(h){var done=h.days.filter(function(d){return wd.includes(d);}).length;return'<div class="wr-bar-row"><div class="wr-bar-l"><span>'+h.icon+' '+esc(h.name)+'</span><span style="font-weight:700;color:'+h.color+'">'+done+'/7</span></div><div class="wr-bar"><div class="wr-bar-f" style="width:'+done/7*100+'%;background:'+h.color+'"></div></div></div>';}).join('');
  el('motivation-quote').textContent=QUOTES[Math.floor(Math.random()*QUOTES.length)];
}
function toggleHabit(id,date){var h=S.habits.find(function(x){return x.id===id;});if(!h)return;if(h.days.includes(date)){h.days=h.days.filter(function(d){return d!==date;});if(h.streak>0)h.streak--;}else{h.days.push(date);h.streak++;}saveState();renderHabits();toast(h.days.includes(date)?h.icon+' ¬°H√°bito completado!':'Desmarcado');}

/* ‚ïê‚ïê‚ïê NOTES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var NOTE_COLORS=['#f8fce8','#fff8e8','#f0f8ff','#fff0f5','#f0fff4'];
function renderNotes(){
  el('notes-grid').innerHTML=S.notes.map(function(n,i){return'<div class="note-card" data-nid="'+n.id+'" style="background:'+NOTE_COLORS[i%NOTE_COLORS.length]+';border-top:3px solid '+n.color+';"><button class="note-del" data-ndel="'+n.id+'">√ó</button><div class="note-title">'+esc(n.title)+'</div><div class="note-body">'+esc(n.body.slice(0,150))+(n.body.length>150?'‚Ä¶':'')+'</div><span class="note-tag" style="background:'+n.color+'18;color:'+n.color+'">'+esc(n.tag)+'</span><div class="note-date">'+fmtD(n.date)+'</div></div>';}).join('')+'<div class="note-card" id="btn-add-note-card" style="background:var(--bg2);border:1.5px dashed var(--brd);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:140px;cursor:pointer;"><div style="font-size:24px;color:var(--text4);margin-bottom:6px;">+</div><div style="font-size:12px;color:var(--text4);font-weight:700;">Nueva nota</div></div>';
  document.querySelectorAll('.note-card[data-nid]').forEach(function(c){c.addEventListener('click',function(){openNoteDetail(parseInt(c.dataset.nid));});});
  document.querySelectorAll('[data-ndel]').forEach(function(b){b.addEventListener('click',function(e){e.stopPropagation();S.notes=S.notes.filter(function(n){return n.id!==parseInt(b.dataset.ndel);});renderNotes();saveState();toast('Nota eliminada');});});
  var add=el('btn-add-note-card');if(add)add.addEventListener('click',openNewNote);
}

/* ‚ïê‚ïê‚ïê REVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderReview(){
  var wd=wkDays(S.calDate);
  el('review-period').textContent=fmtD(ds(wd[0]))+' ‚Äì '+fmtD(ds(wd[6]))+' ¬∑ '+S.calDate.getFullYear();
  var allT=S.projects.reduce(function(a,p){return a.concat(p.tasks);},[]);
  var doneT=allT.filter(function(t){return t.status==='done';}).length;
  var inpT=allT.filter(function(t){return t.status==='progress';}).length;
  var wkEvs=S.events.filter(function(e){return wd.some(function(x){return ds(x)===e.date;});});
  var habDone=S.habits.reduce(function(a,h){return a+h.days.filter(function(d){return wd.some(function(x){return ds(x)===d;});}).length;},0);
  var maxH=S.habits.length*7||1;
  el('review-grid').innerHTML='<div class="wr-card"><div class="wr-title">M√©tricas</div>'+[['Tareas completadas',doneT],['En progreso',inpT],['Eventos',wkEvs.length],['üçÖ Pomodoros',S.timer.pomodoros],['H√°bitos',habDone+'/'+maxH]].map(function(x){return'<div class="wr-metric"><div style="font-size:12px;color:var(--text2);">'+x[0]+'</div><div class="wr-mv">'+x[1]+'</div></div>';}).join('')+'</div><div class="wr-card"><div class="wr-title">Productividad Diaria</div>'+wd.map(function(d){var ev=S.events.filter(function(e){return e.date===ds(d);}).length;return'<div class="wr-bar-row"><div class="wr-bar-l"><span>'+DAYS_SH[d.getDay()]+'</span><span style="color:var(--fern);font-weight:700">'+ev+' ev.</span></div><div class="wr-bar"><div class="wr-bar-f" style="width:'+Math.min(ev/3*100,100)+'%;background:var(--sage)"></div></div></div>';}).join('')+'</div>';
  el('review-projects').innerHTML=S.projects.map(function(p){var pp=pprog(p);return'<div class="wr-bar-row"><div class="wr-bar-l"><span>'+esc(p.icon)+' '+esc(p.name)+'</span><span style="color:'+p.color+';font-weight:700">'+pp+'%</span></div><div class="wr-bar"><div class="wr-bar-f" style="width:'+pp+'%;background:'+p.color+'"></div></div></div>';}).join('');
  var wins=[];
  if(doneT>0)wins.push('Completaste '+doneT+' tarea'+(doneT>1?'s':'')+' üéâ');
  if(S.timer.pomodoros>0)wins.push(S.timer.pomodoros+' sesiones de focus üçÖ');
  if(habDone>maxH*.7)wins.push('Excelente consistencia en h√°bitos üåø');
  el('review-wins').innerHTML=wins.length>0?wins.map(function(w){return'<div class="win-item"><span>‚ú¶</span>'+esc(w)+'</div>';}).join(''):'<div style="font-size:12px;color:var(--text4);padding:8px;">Registra actividad para ver tus logros.</div>';
  el('review-next').innerHTML=['üéØ Revisar y priorizar backlog de proyectos','üìÖ Bloquear tiempo para tareas de alta prioridad','üåø Mantener consistencia en h√°bitos'].map(function(w){return'<div class="win-item" style="background:var(--gold-l);border:1px solid #e8d8a0;"><span>'+w.slice(0,2)+'</span>'+esc(w.slice(2))+'</div>';}).join('');
}

/* ‚ïê‚ïê‚ïê NEW/EDIT MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openNewProject(){
  openModal('<div class="modal-title">Nuevo Proyecto</div><div class="fr"><label>NOMBRE</label><input type="text" id="np-name" placeholder="Ej: Redise√±o de plataforma‚Ä¶"/></div><div class="fr"><label>DESCRIPCI√ìN</label><textarea id="np-desc" rows="2" placeholder="Breve descripci√≥n‚Ä¶"></textarea></div><div class="fr mg2"><div><label>FECHA L√çMITE</label><input type="date" id="np-dl"/></div><div><label>ICONO</label><div class="ico-grid" id="np-icons">'+iconGridHTML()+'</div><input type="hidden" id="icon-val" value="'+ICONS[0]+'"/></div></div><div class="fr"><label>COLOR</label><div class="cs" id="np-cs">'+pickerHTML('np',COLORS,0)+'</div><input type="hidden" id="np-color-val" value="'+COLORS[0]+'"/></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-np">Crear Proyecto</button></div>');
  el('btn-save-np').addEventListener('click',function(){
    var name=el('np-name')&&el('np-name').value.trim();if(!name)return;
    S.projects.push({id:_pid++,name:name,icon:el('icon-val').value,color:el('np-color-val').value,desc:el('np-desc').value,deadline:el('np-dl').value,tasks:[]});
    closeModal();renderDashboard();saveState();toast('Proyecto creado ‚úì');
  });
  setTimeout(function(){var inp=el('np-name');if(inp)inp.focus();},50);
}

function openNewTask(){
  var p=S.projects.find(function(x){return x.id===S.activeProject;});if(!p)return;
  _tmpCL=[];
  openModal('<div class="modal-title">Nueva Tarea</div><div style="font-size:11px;color:var(--text3);margin:-12px 0 16px;">'+esc(p.icon)+' '+esc(p.name)+'</div><div class="fr"><label>T√çTULO</label><input type="text" id="nt-title" placeholder="Describe la tarea‚Ä¶"/></div><div class="fr mg3"><div><label>PRIORIDAD</label><select id="nt-prio"><option value="low">Baja</option><option value="medium" selected>Media</option><option value="high">Alta</option></select></div><div><label>RESPONSABLE</label><input type="text" id="nt-as" placeholder="Nombre‚Ä¶"/></div><div><label>FECHA L√çMITE</label><input type="date" id="nt-due"/></div></div><div class="fr"><div class="cl-sec"><div class="cl-hd"><div class="cl-lbl">CHECKLIST</div></div><div id="cl-items-container"></div><div class="cl-add"><input type="text" id="cl-new-item" placeholder="√çtem del checklist‚Ä¶"/><button id="btn-cl-add">+</button></div></div></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-nt">Agregar Tarea</button></div>');
  el('btn-cl-add').addEventListener('click',function(){addCheckItem('cl-new-item');});
  el('cl-new-item').addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();addCheckItem('cl-new-item');}});
  el('btn-save-nt').addEventListener('click',function(){
    var title=el('nt-title')&&el('nt-title').value.trim();if(!title)return;
    p.tasks.push({id:_tid++,title:title,status:'todo',priority:el('nt-prio').value,assignee:el('nt-as').value,due:el('nt-due').value,checklist:_tmpCL.slice()});
    _tmpCL=[];closeModal();renderKanban();saveState();toast('Tarea creada ‚úì');
  });
  setTimeout(function(){var inp=el('nt-title');if(inp)inp.focus();},50);
}

function openTaskDetail(pid,tid){
  var p=S.projects.find(function(x){return x.id==pid;}),t=p&&p.tasks.find(function(x){return x.id==tid;});if(!t)return;
  _tmpCL=t.checklist.map(function(c){return Object.assign({},c);});
  var pp=prog(_tmpCL);
  openModal('<div style="display:flex;justify-content:space-between;margin-bottom:18px;"><div style="display:flex;align-items:center;gap:8px;"><div style="width:10px;height:10px;border-radius:50%;background:'+p.color+'"></div><span style="font-size:10px;font-weight:700;color:'+p.color+';letter-spacing:1px;">'+esc(p.name.toUpperCase())+'</span></div><div style="display:flex;gap:8px;"><button class="btn btn-d" id="btn-del-task">Eliminar</button><button class="btn btn-p" id="btn-save-td">Guardar</button></div></div><input type="text" id="td-title" value="'+esc(t.title)+'" style="font-family:var(--fd);font-size:18px;font-weight:600;background:transparent;border:none;border-bottom:2px solid var(--brd);border-radius:0;color:var(--text);width:100%;padding:4px 0;margin-bottom:16px;outline:none;"/><div class="mg3 fr"><div><label>PRIORIDAD</label><select id="td-prio"><option value="low"'+(t.priority==='low'?' selected':'')+'>Baja</option><option value="medium"'+(t.priority==='medium'?' selected':'')+'>Media</option><option value="high"'+(t.priority==='high'?' selected':'')+'>Alta</option></select></div><div><label>RESPONSABLE</label><input type="text" id="td-as" value="'+esc(t.assignee||'')+'"/></div><div><label>FECHA L√çMITE</label><input type="date" id="td-due" value="'+esc(t.due||'')+'"/></div></div><div class="cl-sec"><div class="cl-hd"><div class="cl-lbl">CHECKLIST</div>'+progBarHTML(pp,p.color)+'</div><div id="cl-items-container">'+checklistHTML(_tmpCL,p.color)+'</div><div class="cl-add"><input type="text" id="cl-new-item" placeholder="Nuevo √≠tem‚Ä¶"/><button id="btn-cl-add">+</button></div></div>');
  el('btn-cl-add').addEventListener('click',function(){addCheckItem('cl-new-item');});
  el('cl-new-item').addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();addCheckItem('cl-new-item');}});
  el('btn-del-task').addEventListener('click',function(){delTask(pid,tid);closeModal();});
  el('btn-save-td').addEventListener('click',function(){
    t.title=el('td-title').value;t.priority=el('td-prio').value;t.assignee=el('td-as').value;t.due=el('td-due').value;
    t.checklist=_tmpCL.slice();_tmpCL=[];closeModal();renderKanban();saveState();toast('Guardado ‚úì');
  });
}

function openNewEvent(dateStr,h){
  _tmpCL=[];
  var def=dateStr||ds(S.calDate),defH=h!=null?h:9;
  openModal('<div class="modal-title">Nuevo Evento</div><div class="fr"><label>T√çTULO</label><input type="text" id="ne-title" placeholder="Nombre del evento‚Ä¶"/></div><div class="fr mg2"><div><label>GRUPO</label><select id="ne-grp">'+S.groups.map(function(g){return'<option value="'+g.id+'">'+g.icon+' '+esc(g.name)+'</option>';}).join('')+'</select></div><div><label>PROYECTO</label><select id="ne-proj"><option value="">Sin proyecto</option>'+S.projects.map(function(p){return'<option value="'+p.id+'">'+p.icon+' '+esc(p.name)+'</option>';}).join('')+'</select></div></div><div class="fr mg3"><div><label>FECHA</label><input type="date" id="ne-date" value="'+def+'"/></div><div><label>INICIO</label><select id="ne-sh">'+Array.from({length:24},function(_,i){return'<option value="'+i+'"'+(i===defH?' selected':'')+'>'+pad(i)+':00</option>';}).join('')+'</select></div><div><label>FIN</label><select id="ne-eh">'+Array.from({length:24},function(_,i){return'<option value="'+i+'"'+(i===defH+1?' selected':'')+'>'+pad(i)+':00</option>';}).join('')+'</select></div></div><div class="fr"><div class="cl-sec"><div class="cl-hd"><div class="cl-lbl">CHECKLIST DEL EVENTO</div></div><div id="cl-items-container"></div><div class="cl-add"><input type="text" id="cl-new-item" placeholder="√çtem‚Ä¶"/><button id="btn-cl-add">+</button></div></div></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-ne">Crear Evento</button></div>');
  el('btn-cl-add').addEventListener('click',function(){addCheckItem('cl-new-item');});
  el('cl-new-item').addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();addCheckItem('cl-new-item');}});
  el('btn-save-ne').addEventListener('click',function(){
    var title=el('ne-title')&&el('ne-title').value.trim();if(!title)return;
    var sh=parseInt(el('ne-sh').value),eh=parseInt(el('ne-eh').value);
    S.events.push({id:_eid++,title:title,groupId:el('ne-grp').value,projectId:el('ne-proj').value||null,date:el('ne-date').value,startH:sh,endH:eh>sh?eh:sh+1,checklist:_tmpCL.slice()});
    _tmpCL=[];closeModal();renderCalendar();saveState();toast('Evento creado ‚úì');
  });
  setTimeout(function(){var inp=el('ne-title');if(inp)inp.focus();},50);
}

function openEventDetail(eid){
  var ev=S.events.find(function(e){return e.id==eid;});if(!ev)return;
  var g=S.groups.find(function(x){return x.id===ev.groupId;})||{color:'var(--sage)',icon:'‚óè',name:'Sin grupo'};
  _tmpCL=ev.checklist.map(function(c){return Object.assign({},c);});
  var pp=prog(_tmpCL);
  openModal('<div style="display:flex;justify-content:space-between;margin-bottom:18px;"><div style="display:flex;align-items:center;gap:8px;"><div style="width:10px;height:10px;border-radius:3px;background:'+g.color+'"></div><span style="font-size:10px;font-weight:700;color:'+g.color+';letter-spacing:1px;">'+esc(g.name.toUpperCase())+'</span></div><div style="display:flex;gap:8px;"><button class="btn btn-d" id="btn-del-ev">Eliminar</button><button class="btn btn-p" id="btn-save-ed">Guardar</button></div></div><input type="text" id="ed-title" value="'+esc(ev.title)+'" style="font-family:var(--fd);font-size:18px;font-weight:600;background:transparent;border:none;border-bottom:2px solid var(--brd);border-radius:0;color:var(--text);width:100%;padding:4px 0;margin-bottom:16px;outline:none;"/><div class="mg3 fr"><div><label>FECHA</label><input type="date" id="ed-date" value="'+ev.date+'"/></div><div><label>INICIO</label><select id="ed-sh">'+Array.from({length:24},function(_,i){return'<option value="'+i+'"'+(i===ev.startH?' selected':'')+'>'+pad(i)+':00</option>';}).join('')+'</select></div><div><label>FIN</label><select id="ed-eh">'+Array.from({length:24},function(_,i){return'<option value="'+i+'"'+(i===ev.endH?' selected':'')+'>'+pad(i)+':00</option>';}).join('')+'</select></div></div><div class="fr mg2"><div><label>GRUPO</label><select id="ed-grp">'+S.groups.map(function(gg){return'<option value="'+gg.id+'"'+(gg.id===ev.groupId?' selected':'')+'>'+gg.icon+' '+esc(gg.name)+'</option>';}).join('')+'</select></div><div><label>PROYECTO</label><select id="ed-proj"><option value="">Sin proyecto</option>'+S.projects.map(function(p){return'<option value="'+p.id+'"'+(String(p.id)===String(ev.projectId)?' selected':'')+'>'+p.icon+' '+esc(p.name)+'</option>';}).join('')+'</select></div></div><div class="cl-sec"><div class="cl-hd"><div class="cl-lbl">CHECKLIST</div>'+progBarHTML(pp,g.color)+'</div><div id="cl-items-container">'+checklistHTML(_tmpCL,g.color)+'</div><div class="cl-add"><input type="text" id="cl-new-item" placeholder="Nuevo √≠tem‚Ä¶"/><button id="btn-cl-add">+</button></div></div>');
  el('btn-cl-add').addEventListener('click',function(){addCheckItem('cl-new-item');});
  el('cl-new-item').addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();addCheckItem('cl-new-item');}});
  el('btn-del-ev').addEventListener('click',function(){S.events=S.events.filter(function(e){return e.id!=eid;});closeModal();renderCalendar();saveState();toast('Evento eliminado');});
  el('btn-save-ed').addEventListener('click',function(){
    ev.title=el('ed-title').value;ev.date=el('ed-date').value;ev.startH=parseInt(el('ed-sh').value);ev.endH=parseInt(el('ed-eh').value);ev.groupId=el('ed-grp').value;ev.projectId=el('ed-proj').value||null;ev.checklist=_tmpCL.slice();
    _tmpCL=[];closeModal();renderCalendar();saveState();toast('Evento guardado ‚úì');
  });
}

function openNewGroup(){
  openModal('<div class="modal-title">Nuevo Grupo</div><div class="fr"><label>NOMBRE</label><input type="text" id="ng-name" placeholder="Ej: Dise√±o‚Ä¶"/></div><div class="fr"><label>ICONO</label><div class="ico-grid">'+iconGridHTML()+'</div><input type="hidden" id="icon-val" value="'+ICONS[0]+'"/></div><div class="fr"><label>COLOR</label><div class="cs">'+pickerHTML('ng',COLORS,0)+'</div><input type="hidden" id="ng-color-val" value="'+COLORS[0]+'"/></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-ng">Crear Grupo</button></div>');
  el('btn-save-ng').addEventListener('click',function(){var name=el('ng-name')&&el('ng-name').value.trim();if(!name)return;var g={id:'g'+(_gid++),name:name,icon:el('icon-val').value,color:el('ng-color-val').value};S.groups.push(g);S.grpFilters.add(g.id);closeModal();renderCalendar();saveState();toast('Grupo creado ‚úì');});
  setTimeout(function(){var inp=el('ng-name');if(inp)inp.focus();},50);
}

function openNewHabit(){
  openModal('<div class="modal-title">Nuevo H√°bito</div><div class="fr"><label>NOMBRE</label><input type="text" id="nh-name" placeholder="Ej: Meditaci√≥n‚Ä¶"/></div><div class="fr"><label>ICONO</label><div class="ico-grid">'+iconGridHTML()+'</div><input type="hidden" id="icon-val" value="'+ICONS[0]+'"/></div><div class="fr"><label>COLOR</label><div class="cs">'+pickerHTML('nh',COLORS,0)+'</div><input type="hidden" id="nh-color-val" value="'+COLORS[0]+'"/></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-nh">Crear H√°bito</button></div>');
  el('btn-save-nh').addEventListener('click',function(){var name=el('nh-name')&&el('nh-name').value.trim();if(!name)return;S.habits.push({id:_hid++,name:name,icon:el('icon-val').value,color:el('nh-color-val').value,days:[],streak:0});closeModal();renderHabits();saveState();toast('H√°bito creado ‚úì');});
  setTimeout(function(){var inp=el('nh-name');if(inp)inp.focus();},50);
}

function openNewNote(){
  openModal('<div class="modal-title">Nueva Nota</div><div class="fr"><label>T√çTULO</label><input type="text" id="nn-title" placeholder="T√≠tulo‚Ä¶"/></div><div class="fr"><label>CONTENIDO</label><textarea id="nn-body" rows="5" placeholder="Escribe aqu√≠‚Ä¶"></textarea></div><div class="fr mg2"><div><label>ETIQUETA</label><input type="text" id="nn-tag" placeholder="Ej: Ideas"/></div><div><label>COLOR</label><div class="cs">'+pickerHTML('nn',COLORS,0)+'</div><input type="hidden" id="nn-color-val" value="'+COLORS[0]+'"/></div></div><div class="btn-row"><button class="btn btn-s" id="modal-close-btn">Cancelar</button><button class="btn btn-p" id="btn-save-nn">Guardar Nota</button></div>');
  el('btn-save-nn').addEventListener('click',function(){var title=el('nn-title')&&el('nn-title').value.trim();if(!title)return;S.notes.push({id:_nid++,title:title,body:el('nn-body').value,tag:el('nn-tag').value||'General',color:el('nn-color-val').value,date:tds()});closeModal();renderNotes();saveState();toast('Nota guardada ‚úì');});
  setTimeout(function(){var inp=el('nn-title');if(inp)inp.focus();},50);
}

function openNoteDetail(id){
  var n=S.notes.find(function(x){return x.id==id;});if(!n)return;
  openModal('<div style="display:flex;justify-content:space-between;margin-bottom:16px;"><div style="font-size:10px;font-weight:700;color:'+n.color+';letter-spacing:1px;">'+esc(n.tag.toUpperCase())+'</div><div style="display:flex;gap:8px;"><button class="btn btn-d" id="btn-del-note">Eliminar</button><button class="btn btn-p" id="btn-save-note">Guardar</button></div></div><input type="text" id="ne2-title" value="'+esc(n.title)+'" style="font-family:var(--fd);font-size:18px;font-weight:600;background:transparent;border:none;border-bottom:2px solid var(--brd);border-radius:0;color:var(--text);width:100%;padding:4px 0;margin-bottom:14px;outline:none;"/><textarea id="ne2-body" rows="8" style="width:100%;background:var(--bg2);border:1.5px solid var(--brd);border-radius:8px;color:var(--text);padding:10px 12px;font-size:13px;font-family:var(--fb);outline:none;resize:vertical;">'+esc(n.body)+'</textarea>');
  el('btn-del-note').addEventListener('click',function(){S.notes=S.notes.filter(function(x){return x.id!==id;});closeModal();renderNotes();saveState();toast('Nota eliminada');});
  el('btn-save-note').addEventListener('click',function(){n.title=el('ne2-title').value;n.body=el('ne2-body').value;n.date=tds();closeModal();renderNotes();saveState();toast('Nota actualizada ‚úì');});
}

/* ‚ïê‚ïê‚ïê TOAST + NOTIFY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toast(msg){var t=el('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2600);}
function notify(title,body){var w=el('nwrap'),d=document.createElement('div');d.className='notif';d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><div class="notif-t">'+esc(title)+'</div><div class="notif-b">'+esc(body)+'</div></div><button class="notif-x">√ó</button></div>';d.querySelector('.notif-x').addEventListener('click',function(){d.remove();});w.appendChild(d);setTimeout(function(){if(d.parentNode)d.remove();},7000);}

/* ‚ïê‚ïê‚ïê EVENT WIRING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Sidebar nav
document.querySelectorAll('.nb[data-view]').forEach(function(btn){btn.addEventListener('click',function(){switchView(btn.dataset.view);});});
el('btn-toggle-sb').addEventListener('click',function(){document.getElementById('sidebar').classList.toggle('col');});
el('btn-new-proj').addEventListener('click',openNewProject);
el('btn-dash-np').addEventListener('click',openNewProject);
el('btn-new-task').addEventListener('click',openNewTask);
el('btn-new-event').addEventListener('click',function(){openNewEvent(null,null);});
el('btn-new-group').addEventListener('click',openNewGroup);
el('btn-new-habit').addEventListener('click',openNewHabit);
el('btn-new-note').addEventListener('click',openNewNote);
el('btn-main-cta').addEventListener('click',function(){var acts={dashboard:openNewProject,kanban:openNewTask,calendar:function(){openNewEvent(null,null);},matrix:function(){openMAdd('do','#b87878','Hazlo Ya');},habits:openNewHabit,notes:openNewNote};var fn=acts[S.view];if(fn)fn();});
el('btn-cal-prev').addEventListener('click',function(){calNav(-1);});
el('btn-cal-next').addEventListener('click',function(){calNav(1);});
el('btn-cal-today').addEventListener('click',function(){S.calDate=new Date();el('cal-ttl').textContent=calHdr();renderCalView();});
el('btn-mc-prev').addEventListener('click',function(){S.mcDate=new Date(S.mcDate);S.mcDate.setMonth(S.mcDate.getMonth()-1);renderMC();});
el('btn-mc-next').addEventListener('click',function(){S.mcDate=new Date(S.mcDate);S.mcDate.setMonth(S.mcDate.getMonth()+1);renderMC();});
document.querySelectorAll('#cal-vs .vt').forEach(function(btn){btn.addEventListener('click',function(){setCalView(btn.dataset.calview);});});
el('timer-mini').addEventListener('click',function(){switchView('timer');});
el('btn-timer-toggle').addEventListener('click',timerToggle);
el('btn-timer-reset').addEventListener('click',timerReset);
el('btn-timer-skip').addEventListener('click',function(){timerComplete();});
document.querySelectorAll('#timer-mode-tabs .vt').forEach(function(btn){btn.addEventListener('click',function(){
  if(S.timer.running)timerToggle();
  var m=btn.dataset.tmode;S.timer.mode=m;S.timer.seconds=TMODES[m].secs;S.timer.totalSeconds=TMODES[m].secs;
  document.querySelectorAll('#timer-mode-tabs .vt').forEach(function(b){b.classList.remove('act');});btn.classList.add('act');
  updateTimerDisp();
});});
el('alert-pill').addEventListener('click',function(){switchView('dashboard');});

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Load persisted data first
loadState();
// Wire sync bar buttons
el('btn-export').addEventListener('click', exportJSON);
el('import-file').addEventListener('change', function(e){ importJSON(e.target.files[0]); this.value=''; });
el('btn-reset').addEventListener('click', resetData);
// Start app
switchView('dashboard');
setTimeout(function(){var r=getAlerts();if(r.alerts.length>0)notify('üîî '+r.alerts.length+' alerta'+(r.alerts.length>1?'s':'')+' pendiente'+(r.alerts.length>1?'s':''),r.pending+' √≠tems de checklist por completar.');},1200);

})();
</script>

<div id="sync-bar">
  <div id="sync-status"><div id="sync-dot"></div><span id="sync-msg">Cargando‚Ä¶</span></div>
  <button class="sync-btn" id="btn-export">‚¨á Exportar JSON</button>
  <label class="sync-btn" id="btn-import" for="import-file">‚¨Ü Importar JSON</label>
  <input type="file" id="import-file" accept=".json"/>
  <button class="sync-btn" id="btn-reset">‚Ü∫ Resetear datos</button>
</div>

</body>
</html>
